#rm(list=ls())
library(spatial)
library(raster)
library(lubridate  )
source("M:/Environmental Data Summary/HelperCode/ExpandingExtract.R")

SM=read.csv("C:/Users/Thomas.Oliver/WORK/Git/fish-paste-master/data/SURVEY MASTER.csv") # sub HCBC points
#MARAMP=subset(SM,REGION=="MARIAN")
SM=SM[-which(is.na(SM$LONGITUDE_LOV)),] # change to appropriate coords
coordinates(SM)<-~LONGITUDE_LOV+LATITUDE_LOV

#Get list of rasters
rasterdir="M:/Environmental Data Summary/FinalRasters/NC" # find directory of masked files
rasterlist=list.files(path = rasterdir,recursive = T,pattern = ".nc",full.names = T) 
VERBOSE=TRUE
for(r_i in 1:length(rasterlist)){
  rasname_full=rasterlist[r_i] 
  rasname_sp=strsplit(rasname_full,"/")[[1]]
  rasname=rasname_sp[length(rasname_sp)]
  rasname=gsub(rasname,pattern = "-",replacement = ".")
  this_r=raster(rasterlist[r_i])
  crs(SM)=crs(this_r) 
  if(VERBOSE){print(paste0("Step ",r_i," of ",length(rasterlist),": ",rasname))}
  this_Ex=ExpandingExtract(this_r,SM,Dists = c(0,50,100,1000,2000,4000,8000)) # 
  eval(parse(text=paste0("MARAMP$",rasname,"=this_Ex$values")))
  if(VERBOSE){print(paste0("Step ",r_i," of ",length(rasterlist),": Extraction Complete."))}
  write.csv(SM,"M:/Environmental Data Summary/InSituPointFiles/MARAMP_Point_Extract.csv")
  if(VERBOSE){print(paste0("Step ",r_i," of ",length(rasterlist),": Write Out Complete."))}
}