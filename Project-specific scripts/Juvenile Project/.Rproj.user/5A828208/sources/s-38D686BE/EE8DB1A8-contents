#This script summarizes juvenile data from NCRMP 2013-2019 at the site, stratum, island and sector level
#It also identifies which sectors and strata have been surveyed in all years
#It calculate delta density


rm(list=ls())

#Set Run Flags
DEBUG=TRUE

#LOAD LIBRARY FUNCTIONS ... 
source("C:/Users/Courtney.S.Couch/Documents/GitHub/Benthic-Scripts/Functions/Benthic_Functions_newApp_vTAOfork.R")
source("C:/Users/Courtney.S.Couch/Documents/GitHub/fish-paste/lib/core_functions.R")
source("C:/Users/Courtney.S.Couch/Documents/GitHub/fish-paste/lib/GIS_functions.R")

setwd("C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project")

#LOAD DATA
jwd<-read.csv("T:/Benthic/Data/REA Coral Demography & Cover/Analysis Ready Raw data/CoralBelt_Juveniles_raw_CLEANED.csv")



## LOAD data
# site.data.gen2<-read.csv("T:/Benthic/Data/REA Coral Demography & Cover/Summary Data/Site/BenthicREA_sitedata_GENUS.csv")

#Tweaks before calculating Site-level data-------------------------------------------------
#Colony fragments and scleractinans are subseted in the functions 
#Add a column for adult fragments so we can remove them from the dataset later (-1 indicates fragment)
jwd$Fragment <- 0 # you need to add this column so that you can use the site level functions correctly
jwd$DATE_ <- as.Date(jwd$DATE_, format = "%Y-%m-%d")
jwd$METHOD<-"DIVER"
jwd$ANALYST<-jwd$DIVER
jwd$SEGAREA<-jwd$SEGLENGTH*jwd$SEGWIDTH

#Create a look a table of all of the colony attributes- you will need this the functions below
SURVEY_SITE<-c("METHOD","MISSIONID","DATE_","SITEVISITID", "ANALYSIS_YEAR","OBS_YEAR", "REGION", "REGION_NAME", "ISLAND","ISLANDCODE","SEC_NAME", "SITE","HABITAT_CODE","REEF_ZONE",
               "DEPTH_BIN", "LATITUDE", "LONGITUDE","MIN_DEPTH_M","MAX_DEPTH_M")
survey_site<-unique(jwd[,SURVEY_SITE])

#TEMPORARY WORK AROUND-ASK MICHAEL TO FIX
survey_site$REEF_ZONE<-ifelse(survey_site$SITE=="HAW-04285","Forereef",as.character(survey_site$REEF_ZONE))

#Remove 2 sites that weren't surveyed for juveniles
jwd<-jwd[!(jwd$SITE %in% c("OFU-01012","PAG-00596")),]

#Look at the size class data to determine the min colony size cut off for analysis
#Subset 2019 Hawaii data
hi<-subset(jwd,OBS_YEAR=="2019")

ggplot(hi) + 
  geom_density(aes(x = COLONYLENGTH, fill = ANALYST), alpha = 0.2)+
  geom_vline(xintercept=1, color = "black")+
  facet_wrap(~ISLAND)

ggplot(hi) + 
  geom_histogram(aes(x = COLONYLENGTH, fill = ANALYST))+
  geom_vline(xintercept=1, color = "black")+
  facet_wrap(~ISLAND)

ggplot(hi) + 
  geom_density(aes(x = COLONYLENGTH, fill = ISLAND), alpha = 0.2)+
  geom_vline(xintercept=1, color = "black")+
  facet_wrap(~ISLAND)

s.data<-ddply(hi,.(ISLAND,ANALYST),
              summarise,
         min=min(COLONYLENGTH,na.rm=T),
         mean=mean(COLONYLENGTH,na.rm=T),
         ncol=length(COLONYLENGTH,na.rm=T))

s.all<-ddply(jwd,.(ISLAND,ANALYST),
              summarise,
              min=min(COLONYLENGTH,na.rm=T),
              mean=mean(COLONYLENGTH,na.rm=T),
              ncol=length(COLONYLENGTH))

#Change colonies that are <1cm or >5cm to NA. I'm not subsetting these data because I need to keep the placeholder in the dataframe in case a site only had colonies <1cm or >5cm
View(subset(jwd,COLONYLENGTH<1))
nrow(subset(jwd,COLONYLENGTH<1))
nrow(jwd)
jwd$S_ORDER<-ifelse(jwd$COLONYLENGTH<1|jwd$COLONYLENGTH==5,NA,as.character(jwd$S_ORDER))
jwd$GENUS_CODE<-ifelse(jwd$COLONYLENGTH<1|jwd$COLONYLENGTH==5,NA,as.character(jwd$GENUS_CODE))
jwd$TAXONCODE<-ifelse(jwd$COLONYLENGTH<1|jwd$COLONYLENGTH==5,NA,as.character(jwd$TAXONCODE))
jwd$SPCODE<-ifelse(jwd$COLONYLENGTH<1|jwd$COLONYLENGTH==5,NA,as.character(jwd$SPCODE))
jwd$COLONYLENGTH<-ifelse(jwd$COLONYLENGTH<1|jwd$COLONYLENGTH==5,NA,jwd$COLONYLENGTH)

nrow(subset(jwd,COLONYLENGTH>1))
View(subset(jwd,COLONYLENGTH>1))

nrow(jwd)
View(jwd)



# Generate Juvenile Density at the TRANSECT & SITE-LEVEL BY GENUS--------------------------------------------------
jcd.gen<-Calc_ColDen_Transect(jwd,"GENUS_CODE"); colnames(jcd.gen)[colnames(jcd.gen)=="ColCount"]<-"JuvColCount";colnames(jcd.gen)[colnames(jcd.gen)=="ColDen"]<-"JuvColDen";colnames(jcd.gen)[colnames(jcd.gen)=="TRANSECTAREA"]<-"TRANSECTAREA_j"

site.data.gen<-ddply(jcd.gen, .(SITE,SITEVISITID,GENUS_CODE), #calc total colonies by condition
                     summarise,
                     JuvColDen=mean(JuvColDen,na.rm=T))

site.data.gen2<-site.data.gen
                     
# Merge Site level data with sectors file and export site data ------------
sectors<-read.csv("C:/Users/Courtney.S.Couch/Documents/GitHub/fish-paste/data/Sectors-Strata-Areas.csv", stringsAsFactors=FALSE)

#Merge together survey meta data and sector area files and check for missmatches 
meta<-left_join(survey_site,sectors)
meta[which(is.na(meta$AREA_HA)),]
nrow(survey_site)
nrow(meta)


#Merge site level data and meta data
site.data.gen2<-left_join(site.data.gen2,meta)
site.data.gen2$Juvpres.abs<-ifelse(site.data.gen2$JuvColDen>0,1,0)


#Change all special missions to exclude flag =-1, right now they are 0. Then exclude these sites
#Exclude PRIA 2017 sites because we want similar time intervals following bleaching events for all regions
levels(site.data.gen2$MISSIONID)
site.data.gen2<-site.data.gen2[!site.data.gen2$MISSIONID %in% c("MP1410","MP1512","MP1602","SE1602","MP2006"),]
site.data.gen2$Year_Island<-paste(site.data.gen2$OBS_YEAR,site.data.gen2$ISLAND,sep="_")
site.data.gen2<-site.data.gen2[!site.data.gen2$Year_Island %in% c("2017_Baker","2017_Jarvis","2017_Howland"),] 

site.data.gen2<-droplevels(site.data.gen2);levels(site.data.gen2$MISSIONID)
View(site.data.gen2)

#Convert Protected Reef Slope to Forreef and Subset just Forereef sites
site.data.gen2$REEF_ZONE<-ifelse(site.data.gen2$REEF_ZONE=="Protected Slope","Forereef",as.character(site.data.gen2$REEF_ZONE))
site.data.gen2<-subset(site.data.gen2,REEF_ZONE=="Forereef")

#Remove Johnston from analysis- we only have 2015 data
site.data.gen2<-subset(site.data.gen2,ISLAND!="Johnston")


#Change Regions
site.data.gen2$REGION<-ifelse(site.data.gen2$ISLAND %in% c("FDP", "Maug", "Asuncion", "Alamagan", "Pagan", "Agrihan", "Guguan", "Sarigan","Farallon de Pajaros")
                             ,"NMARIAN", as.character(site.data.gen2$REGION))
site.data.gen2$REGION<-ifelse(site.data.gen2$ISLAND %in% c("Saipan", "Tinian", "Aguijan", "Rota", "Guam")
                             ,"SMARIAN", as.character(site.data.gen2$REGION))
site.data.gen2$REGION<-ifelse(site.data.gen2$ISLAND %in% c("Howland","Baker")
                             ,"PHOENIX", as.character(site.data.gen2$REGION))
site.data.gen2$REGION<-ifelse(site.data.gen2$ISLAND =="Wake"
                              ,"WAKE", as.character(site.data.gen2$REGION))
site.data.gen2$REGION<-ifelse(site.data.gen2$ISLAND %in% c("Kingman","Palmyra","Jarvis")
                             ,"LINE", as.character(site.data.gen2$REGION))

# GENERATE DATA FOR TEMPORAL ANALYSIS---------------------------------------------------
site.data.gen2$STRATANAME<- paste(site.data.gen2$SEC_NAME,site.data.gen2$REEF_ZONE,site.data.gen2$DEPTH_BIN,sep="_")
st.list<-ddply(site.data.gen2,.(METHOD,OBS_YEAR,REGION,ISLAND,SEC_NAME,STRATANAME),summarize,n=length(unique(SITE)))
st.list2<-subset(st.list,n>=2);head(st.list)

#Generate list of strata that were surveyed in all years for a given region and had at least 2 sites/stratum
st.list_w<-dcast(st.list2, formula=METHOD+REGION+ISLAND+SEC_NAME+STRATANAME~ OBS_YEAR, value.var="n",fill=0)
dCOLS<-c("2013","2014","2015","2016","2017","2018","2019")
st.list_w$year_n<-rowSums(st.list_w[,dCOLS] > 0, na.rm=T) #count # of years of data
st.list_w2<-subset(st.list_w,REGION %in% c("NMARIAN","SMARIAN","LINE","PHOENIX","WAKE","SAMOA") & year_n>=2) #only include strata that have at least 2 years
st.list_w3<-subset(st.list_w,REGION %in% c("MHI","NWHI") & year_n>=3)#only include strata that have at least 3 years
st.list_w4<-rbind(st.list_w2,st.list_w3)

head(st.list_w4);st.list_w4<-droplevels(st.list_w4) #generate the list

data.gen_temp<-site.data.gen2[site.data.gen2$STRATANAME %in% c(st.list_w4$STRATANAME),] #Subset juv data to only include strata of intersest 

View(data.gen_temp) #double check that strata were dropped correctly

write.csv(data.gen_temp,file="T:/Benthic/Projects/Juvenile Project/JuvProject_temporal_SITE.csv")

#POOL UP TO STRATA, SECTOR, ISLAND
#Set ANALYSIS_SCHEMA to STRATA and DOMAIN_SCHEMA to whatever the highest level you want estimates for (e.g. sector, island, region)
data.gen_temp$ANALYSIS_SCHEMA<-data.gen_temp$STRATANAME
data.gen_temp$DOMAIN_SCHEMA<-data.gen_temp$SEC_NAME
data.gen_temp$ANALYSIS_YEAR<-data.gen_temp$OBS_YEAR
data.gen_temp$DB_RZ<-paste(data.gen_temp$DEPTH_BIN,data.gen_temp$REEF_ZONE,sep="_")

#Create a vector of columns to subset for strata estimates
c.keep<-c("METHOD","REGION","ISLAND","DOMAIN_SCHEMA","ANALYSIS_YEAR","ANALYSIS_SCHEMA","REEF_ZONE","DB_RZ","GENUS_CODE",
          "n_h","N_h","D._h","SE_D._h")

jcdG_st<-Calc_Strata(data.gen_temp,"GENUS_CODE","JuvColDen","Juvpres.abs");jcdG_st=jcdG_st[,c.keep]
colnames(jcdG_st)<-c("METHOD","REGION","ISLAND","SEC_NAME","ANALYSIS_YEAR","STRATANAME","REEF_ZONE","DB_RZ","GENUS_CODE","n","Ntot","JuvColDen","SE_JuvColDen")
jcdG_st$ANALYSIS_YEAR<-as.factor(jcdG_st$ANALYSIS_YEAR)
head(jcdG_st)

#Double Check that revised pooling is adding up NH (total sites) correctly
View(jcdG_st)
View(sectors)


#Calculate Island Estimates
jcdG_is<-Calc_Domain(data.gen_temp,"GENUS_CODE","JuvColDen","Juvpres.abs")
jcdG_is<-jcdG_is[,c("METHOD","REGION","ANALYSIS_YEAR","DOMAIN_SCHEMA","GENUS_CODE","n","Ntot","Mean_JuvColDen","SE_JuvColDen")]

#Calculate Sector Estimates
data.gen_temp$ANALYSIS_SCHEMA<-data.gen_temp$STRATANAME
data.gen_temp$DOMAIN_SCHEMA<-data.gen_temp$SEC_NAME

jcdG_sec<-Calc_Domain(data.gen_temp,"GENUS_CODE","JuvColDen","Juvpres.abs")
jcdG_sec<-jcdG_sec[,c("METHOD","REGION","ANALYSIS_YEAR","DOMAIN_SCHEMA","GENUS_CODE","n","Ntot","Mean_JuvColDen","SE_JuvColDen")]

write.csv(jcdG_st,file="T:/Benthic/Projects/Juvenile Project/JuvProject_temporal_STRATA.csv")
write.csv(jcdG_is,file="T:/Benthic/Projects/Juvenile Project/JuvProject_temporal_ISLAND.csv")
write.csv(jcdG_sec,file="T:/Benthic/Projects/Juvenile Project/JuvProject_temporal_SECTOR.csv")

# write.csv(jcdG_st,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_temporal_STRATA.csv")
# write.csv(jcdG_is,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_temporal_ISLAND.csv")
# write.csv(jcdG_sec,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_temporal_SECTOR.csv")


# CALCULATE DeltaDensity/Year for Correlative Analysis --------------------
#To remove the confounding effect of time, Calculate change since bleaching event or year following bleaching event
#I decided to create new list of strata without 2013 MHI sites- terrible sampling and delta den for MHI is calcualted 2019-2016
# GENERATE DATA FOR TEMPORAL ANALYSIS---------------------------------------------------
site.data.gen2$STRATANAME<- paste(site.data.gen2$SEC_NAME,site.data.gen2$REEF_ZONE,site.data.gen2$DEPTH_BIN,sep="_")
st.list<-ddply(site.data.gen2,.(METHOD,OBS_YEAR,REGION,ISLAND,SEC_NAME,STRATANAME),summarize,n=length(unique(SITE)))
st.list2<-subset(st.list,n>=2);head(st.list)

#Generate list of strata that were surveyed in all years for a given region and had at least 2 sites/stratum
st.list_w<-dcast(st.list2, formula=METHOD+REGION+ISLAND+SEC_NAME+STRATANAME~ OBS_YEAR, value.var="n",fill=0)
dCOLS<-c("2014","2015","2016","2017","2018","2019")
st.list_w$year_n<-rowSums(st.list_w[,dCOLS] > 0, na.rm=T) #count # of years of data
st.list_w2<-subset(st.list_w,REGION %in% c("NMARIAN","SMARIAN","LINE","PHOENIX","WAKE","SAMOA","MHI") & year_n>=2)
st.list_w3<-subset(st.list_w,REGION %in% c("NWHI") & year_n>=3)
st.list_w4<-rbind(st.list_w2,st.list_w3)

head(st.list_w4);st.list_w4<-droplevels(st.list_w4) #generate the list

data.gen_temp<-site.data.gen2[site.data.gen2$STRATANAME %in% c(st.list_w4$STRATANAME),] #Subset juv data to only include strata of intersest 
data.gen_temp<-data.gen_temp[data.gen_temp$OBS_YEAR >2013,] #Remove 2013 MHI data- we had very poor sampling that year and it's 2 years prior to bleaching event

View(data.gen_temp) #double check that strata were dropped correctly


#POOL UP TO STRATA, SECTOR, ISLAND
#Set ANALYSIS_SCHEMA to STRATA and DOMAIN_SCHEMA to whatever the highest level you want estimates for (e.g. sector, island, region)
data.gen_temp$ANALYSIS_SCHEMA<-data.gen_temp$STRATANAME
data.gen_temp$DOMAIN_SCHEMA<-data.gen_temp$SEC_NAME
data.gen_temp$ANALYSIS_YEAR<-data.gen_temp$OBS_YEAR
data.gen_temp$DB_RZ<-paste(data.gen_temp$DEPTH_BIN,data.gen_temp$REEF_ZONE,sep="_")

#Create a vector of columns to subset for strata estimates
c.keep<-c("METHOD","REGION","ISLAND","DOMAIN_SCHEMA","ANALYSIS_YEAR","ANALYSIS_SCHEMA","REEF_ZONE","DB_RZ","GENUS_CODE",
          "n_h","N_h","D._h","SE_D._h")

jcdG_st<-Calc_Strata(data.gen_temp,"GENUS_CODE","JuvColDen","Juvpres.abs");jcdG_st=jcdG_st[,c.keep]
colnames(jcdG_st)<-c("METHOD","REGION","ISLAND","SEC_NAME","ANALYSIS_YEAR","STRATANAME","REEF_ZONE","DB_RZ","GENUS_CODE","n","Ntot","JuvColDen","SE_JuvColDen")
jcdG_st$ANALYSIS_YEAR<-as.factor(jcdG_st$ANALYSIS_YEAR)
head(jcdG_st)

jcdG_st<-cSplit(jcdG_st, 'DB_RZ', sep="_", type.convert=FALSE);colnames(jcdG_st)[colnames(jcdG_st)=="DB_RZ_1"]<-"DEPTH_BIN"
jcdG_stS<-subset(jcdG_st,GENUS_CODE=="SSSS")
jcdst_delta<-jcdG_stS

#Identify median date that surveys were conducted for each strata and year
data.gen_tempS<-subset(data.gen_temp,GENUS_CODE=="SSSS")
date.sum<-ddply(data.gen_tempS,.(METHOD,ANALYSIS_YEAR,REGION,DEPTH_BIN,STRATANAME),
                summarize,
                DATE_=median(DATE_,na.rm=T))
date.sum$ANALYSIS_YEAR<-as.factor(date.sum$ANALYSIS_YEAR)
jcdst_delta$ANALYSIS_YEAR<-as.factor(jcdst_delta$ANALYSIS_YEAR)
strat.data.new<-left_join(jcdst_delta,date.sum)

#Identify median date that surveys were conducted for region and year
temp.date<-ddply(data.gen_tempS,.(ANALYSIS_YEAR,REGION),
                summarize,
                DATE_=median(DATE_,na.rm=T))
temp.date
#Convert date long to wide
strat.data.new$YEAR<-paste("a",strat.data.new$ANALYSIS_YEAR,sep="")
tmp<-strat.data.new[,c("METHOD","REGION","ISLAND","YEAR","STRATANAME","DEPTH_BIN","DATE_")];head(tmp)
n.df <- spread(tmp, YEAR, DATE_);head(n.df)

#Calculate difference between dates
n.df$Tdiff<-NULL
for (i in c(1:nrow(n.df))){ #opening brace
  if(n.df$REGION[i] =="LINE"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2018[i]) ,as.Date(n.df$a2015[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="PHOENIX"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2018[i]) ,as.Date(n.df$a2015[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="SAMOA"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2018[i]) ,as.Date(n.df$a2015[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="WAKE"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2017[i]) ,as.Date(n.df$a2014[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="NMARIAN"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2017[i]) ,as.Date(n.df$a2014[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="SMARIAN"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2017[i]) ,as.Date(n.df$a2014[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="MHI"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2019[i]) ,as.Date(n.df$a2016[i]) , units = c("weeks")) #c&p
  } #c&p
  if(n.df$REGION[i] =="NWHI"){ #c&p
    n.df$Tdiff[i] = difftime(as.Date(n.df$a2016[i]) ,as.Date(n.df$a2014[i]) , units = c("weeks")) #c&p
  } #c&p
} #closing curly brace for entire forloop
head(n.df)

n.df$years<-n.df$Tdiff/52 #transform Tdiff into months

tmp<-strat.data.new[,c("METHOD","REGION","ISLAND","SEC_NAME","YEAR","STRATANAME","DEPTH_BIN","JuvColDen")];head(tmp)
juv.new <- spread(tmp, YEAR, JuvColDen);head(juv.new)

#Calculate difference in Juv density between years
juv.new$DeltaDen<-NULL
for (i in c(1:nrow(juv.new))){ #opening brace
  if(juv.new$REGION[i] =="LINE"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2018[i] - juv.new$a2015[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="PHOENIX"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2018[i] - juv.new$a2015[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="SAMOA"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2018[i] - juv.new$a2015[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="WAKE"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2017[i] - juv.new$a2014[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="NMARIAN"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2017[i] - juv.new$a2014[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="SMARIAN"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2017[i] - juv.new$a2014[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="MHI"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2019[i] - juv.new$a2016[i] #c&p
  } #c&p
  if(juv.new$REGION[i] =="NWHI"){ #c&p
    juv.new$DeltaDen[i] = juv.new$a2016[i] - juv.new$a2014[i] #c&p
  } #c&p
} #closing curly brace for entire forloop
head(juv.new)

#Clean up date and juv datasets and merge & CALCULATE Delta density/year
n.df<-n.df[,c("METHOD","REGION","ISLAND","STRATANAME","DEPTH_BIN","years")];head(n.df)
juv.new<-juv.new[,c("METHOD","REGION","ISLAND","SEC_NAME","STRATANAME","DEPTH_BIN","DeltaDen")];head(juv.new)
delta.df<-left_join(juv.new,n.df);head(delta.df)
delta.df$DeltaDen_mo<-delta.df$DeltaDen/delta.df$years
View(delta.df)

#Summarize delta density by sec name
delta.sumS<-ddply(delta.df,.(REGION,SEC_NAME),
                  summarize,
                  DeltaMEAN=mean(DeltaDen,na.rm=T),
                  DeltaSE=std.error(DeltaDen,na.rm=T))

write.csv(jcdG_st,file="T:/Benthic/Projects/Juvenile Project/JuvProject_STRATAno2013.csv")
write.csv(delta.df,file="T:/Benthic/Projects/Juvenile Project/JuvProject_deltadensity_STRATA.csv")
write.csv(delta.sumS,file="T:/Benthic/Projects/Juvenile Project/JuvProject_deltadensity_SECTOR.csv")


#Identify median Latititude that surveys were conducted for each sector and year
lat.sum<-ddply(data.gen_tempS,.(REGION,ISLAND),
                summarize,
                LATITUDE=median(LATITUDE,na.rm=T))

j.sum<-ddply(delta.df,.(REGION,ISLAND),
               summarize,
               DeltaDen=median(DeltaDen,na.rm=T))
deltaden_lat<-left_join(j.sum,lat.sum)



# Plotting temporal trends ------------------------------------------------

jcdG_sec$ANALYSIS_YEAR<-as.factor(jcdG_sec$ANALYSIS_YEAR)

#bar plots of juv desnity by sector by year
p1<-ggplot(subset(jcdG_sec,GENUS_CODE=="SSSS"), aes(x=DOMAIN_SCHEMA, y=Mean_JuvColDen, fill=ANALYSIS_YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  # guides(fill=FALSE) 
  facet_wrap(~REGION, scales="free_x", labeller=label_parsed) +
  geom_errorbar(aes(ymin=Mean_JuvColDen-SE_JuvColDen, ymax=Mean_JuvColDen+SE_JuvColDen),width=.15, position=position_dodge(.9))+
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90)
    ,plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
    ,legend.position="bottom")+
  labs(x="Sector",y="Mean Juvenile Density/m2")+
  guides(fill=guide_legend(title="Year"))


p1
#ggsave(plot=p1,file="T:/Benthic/Projects/Juvenile Project/Figures/Juv_Temporal.pdf",width=10,height=10)
ggsave(plot=p1,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Juv_Temporal.pdf",width=10,height=10)


#### Calculate Absolute Change- older code####
jcdG_st$YEAR<-paste("a",jcdG_st$ANALYSIS_YEAR,sep="")

tmp<-jcdG_st[,c("REGION","ISLAND","SEC_NAME","STRATANAME","REEF_ZONE","DEPTH_BIN","GENUS_CODE","JuvColDen","YEAR")]

new.df_w<-spread(tmp,YEAR,JuvColDen)
head(new.df_w)

nwhi<-subset(new.df_w,REGION=="NWHI")
mhi<-subset(new.df_w,REGION=="MHI")
nmarian<-subset(new.df_w,REGION=="NMARIAN")
smarian<-subset(new.df_w,REGION=="SMARIAN")
ph<-subset(new.df_w,REGION=="PHOENIX")
line<-subset(new.df_w,REGION=="LINE")
samoa<-subset(new.df_w,REGION=="SAMOA")

head(mhi)

mhi$t2013<-0
mhi$t2014<-NA
mhi$t2015<-NA
mhi$t2016<-mhi$a2016-mhi$a2013
mhi$t2017<-NA
mhi$t2018<-NA
mhi$t2019<-mhi$a2019-mhi$a2016

nwhi$t2013<-NA
nwhi$t2014<-0
nwhi$t2015<-nwhi$a2015-nwhi$a2014
nwhi$t2016<-nwhi$a2016-nwhi$a2015
nwhi$t2017<-NA
nwhi$t2018<-NA
nwhi$t2019<-NA

nmarian$t2013<-NA
nmarian$t2014<-0
nmarian$t2015<-NA
nmarian$t2016<-NA
nmarian$t2017<-nmarian$a2017-nmarian$a2014
nmarian$t2018<-NA
nmarian$t2019<-NA

smarian$t2013<-NA
smarian$t2014<-0
smarian$t2015<-NA
smarian$t2016<-NA
smarian$t2017<-smarian$a2017-smarian$a2014
smarian$t2018<-NA
smarian$t2019<-NA


ph$t2013<-NA
ph$t2014<-NA
ph$t2015<-0
ph$t2016<-NA
ph$t2017<-NA
ph$t2018<-ph$a2018-ph$a2015
ph$t2019<-NA

line$t2013<-NA
line$t2014<-NA
line$t2015<-0
line$t2016<-NA
line$t2017<-NA
line$t2018<-line$a2018-line$a2015
line$t2019<-NA

samoa$t2013<-NA
samoa$t2014<-NA
samoa$t2015<-0
samoa$t2016<-NA
samoa$t2017<-NA
samoa$t2018<-samoa$a2018-samoa$a2015
samoa$t2019<-NA
abschange<-rbind(nwhi,mhi,nmarian,smarian,ph,line,samoa)

abschange<-abschange[,-c(8:14)]; head(abschange)
pc_long<-gather(abschange,Year,Change,t2013:t2019,factor_key = T)

pc_long<-pc_long %>% mutate(Yearn=recode(Year,
                                         `t2013`="2013",
                                         `t2014`="2014",
                                         `t2015`="2015",
                                         `t2016`="2016",
                                         `t2017`="2017",
                                         `t2018`="2018",
                                         `t2019`="2019"))
pc_long$Yearn<-as.numeric(as.character(pc_long$Yearn))
head(pc_long)
pc_longS<-subset(pc_long,GENUS_CODE=="SSSS")

#Point plot of absolute change in mean density by region
p1<-pc_longS %>%
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=Yearn, y=Change, color=REGION)) + 
  geom_smooth(se=FALSE,method="loess",lwd=1.5)+
  geom_point(color="grey")+
  geom_hline(yintercept=0)+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Abs. Change Mean Density")+
  scale_x_continuous(breaks=seq(2013,2019,1))
p1

#ggsave(plot=p1,file="T:/Benthic/Projects/Juvenile Project/Figures/Abschange_REGION_points.pdf",width=8,height=6)
ggsave(plot=p1,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Abschange_REGION_points.pdf",width=8,height=6)

#Point plot of absolute change in mean density by region and depth bin
p2<-pc_longS %>%
  mutate(DEPTH_BIN = fct_relevel(DEPTH_BIN,"Shallow","Mid","Deep")) %>% #reorder varibles
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=Yearn, y=Change, color=REGION)) + 
  geom_smooth(se=FALSE,method="loess",lwd=1.5)+
  geom_point(color="grey")+
  geom_hline(yintercept=0)+
  facet_wrap(~DEPTH_BIN)+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Abs. Change Mean Density")+
  scale_x_continuous(breaks=seq(2013,2019,1))
p2


#Plot mean density over time
jcdG_stS$ANALYSIS_YEAR<-as.numeric(as.character(jcdG_stS$ANALYSIS_YEAR))

jcd_sum<-ddply(jcdG_stS,.(ANALYSIS_YEAR,REGION,DEPTH_BIN),
               summarize,
               jcdMEAN=mean(JuvColDen,na.rm=T),
               jcdSE=std.error(JuvColDen,na.rm=T))

#density v year by region and depth
p3<-jcdG_stS %>%
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=ANALYSIS_YEAR, y=JuvColDen, color=REGION)) + 
  geom_smooth(se=FALSE,method="loess",lwd=1.5)+
  #geom_point(color="grey")+
  #geom_point(color="grey")+
  geom_point(data=jcd_sum,(aes(y=jcdMEAN, x=ANALYSIS_YEAR)),size=3)+
  geom_errorbar(data=jcd_sum,aes(y=jcdMEAN, x=ANALYSIS_YEAR,ymin=jcdMEAN-jcdSE, ymax=jcdMEAN+jcdSE), width=.2)+
  facet_wrap(~fct_relevel(DEPTH_BIN,"Shallow","Mid","Deep"))+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Mean Juvenile Density")+
  scale_x_continuous(breaks=seq(2013,2019,1))
p3

#density v year by region and depth- REGION FACET
p4<-
  ggplot(jcdG_stS,aes(x=ANALYSIS_YEAR, y=JuvColDen, color=DEPTH_BIN)) + 
  geom_smooth(se=FALSE,method="loess",lwd=1.5)+
  geom_point(data=jcd_sum,(aes(y=jcdMEAN, x=ANALYSIS_YEAR)),size=3)+
  geom_errorbar(data=jcd_sum,aes(y=jcdMEAN, x=ANALYSIS_YEAR,ymin=jcdMEAN-jcdSE, ymax=jcdMEAN+jcdSE), width=.2)+
  facet_wrap(~fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN"))+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Mean Juvenile Density")+
  scale_x_continuous(breaks=seq(2013,2019,1))
p4

#Mean density v year by region
jcd_sumR<-ddply(jcdG_stS,.(ANALYSIS_YEAR,REGION),
               summarize,
               jcdMEAN=mean(JuvColDen,na.rm=T),
               jcdSE=std.error(JuvColDen,na.rm=T))

p5<-jcdG_stS %>%
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=ANALYSIS_YEAR, y=JuvColDen, color=REGION)) + 
  geom_smooth(se=FALSE,method="loess",lwd=1.5)+
  geom_point(data=jcd_sumR,(aes(y=jcdMEAN, x=ANALYSIS_YEAR)),size=3)+
  geom_errorbar(data=jcd_sumR,aes(y=jcdMEAN, x=ANALYSIS_YEAR,ymin=jcdMEAN-jcdSE, ymax=jcdMEAN+jcdSE), width=.2)+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Mean Juvenile Density")+
  scale_x_continuous(breaks=seq(2013,2019,1))
p5

p5.5<-jcdG_stS %>%
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=ANALYSIS_YEAR, y=JuvColDen, color=REGION)) + 
  geom_smooth(se=T,method="loess",lwd=1.5)+
  geom_point(data=jcd_sumR,(aes(y=jcdMEAN, x=ANALYSIS_YEAR)),size=3)+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Mean Juvenile Density")+
  scale_x_continuous(breaks=seq(2013,2019,1))
p5.5


jcd_sumR$ANALYSIS_YEAR<-as.factor(jcd_sumR$ANALYSIS_YEAR)
p6<-jcd_sumR %>%
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=ANALYSIS_YEAR, y=jcdMEAN, fill=REGION)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(data=jcd_sumR,aes(y=jcdMEAN, x=ANALYSIS_YEAR,ymin=jcdMEAN-jcdSE, ymax=jcdMEAN+jcdSE), width=.2)+
  facet_wrap(.~REGION,scales = "free_x")+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)
    ,legend.position = "none") + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Mean Juvenile Density")
p6

#blues_2 = brewer.pal(name="BuPu", n=2)
jcd_sumR$ANALYSIS_YEAR<-as.factor(jcd_sumR$ANALYSIS_YEAR)
#Add Posthoc groupings from LMMs
jcd_sumR<- jcd_sumR[order(jcd_sumR$REGION),];jcd_sumR
#jcd_sumR$sig<-c("","","","ab","b","c","a","b","a","b","a","b","","","","")
jcd_sumR$sig<-c("","","ab","b","c","","","","","","a","b","a","b","","")

jcd_sumR$Bleaching<-c("Pre/During","Post","Pre/During","Post","Post","Post","Post","Pre/During","Post","Post","Pre/During","Post","Pre/During","Post","Post","Post")


jcd_sumR$REGION <- factor(jcd_sumR$REGION, levels = c("NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN"))
jcd_sumR$Bleaching <- factor(jcd_sumR$Bleaching, levels = c("Pre/During","Post"))

#bar plot of juv by region by year with post hoc tests and bleaching event timing
p7 <- ggplot(jcd_sumR, aes(x=ANALYSIS_YEAR, y=jcdMEAN)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve='single'), width = 1, color="black",fill="#6666FF") +
  geom_errorbar(data=jcd_sumR,aes(y=jcdMEAN, x=ANALYSIS_YEAR,ymin=jcdMEAN-jcdSE, ymax=jcdMEAN+jcdSE), width=.2)+
  facet_grid(~REGION, scales = "free_x", space = "free") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        #legend.position = "none",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(angle = 90)) +
  #scale_fill_manual(values = c("#CCCCFF","#6666FF")) +
  xlab("Year") +
  ylab("Mean Juvenile Density") +
  scale_y_continuous(expand = c(0,0), limits = c(0,15)) +
  geom_text(data=jcd_sumR,aes(x=ANALYSIS_YEAR,y=jcdMEAN+jcdSE,label=jcd_sumR$sig, group = REGION),
            position = position_dodge(),
            vjust = -0.5) +
  geom_hline(yintercept = 15)
p7

#bar plot of juv by region by year with post hoc tests -NO BLEACHING

p8 <- ggplot(jcd_sumR, aes(x=ANALYSIS_YEAR, y=jcdMEAN)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve='single'), width = 1, color="black") +
  geom_errorbar(data=jcd_sumR,aes(y=jcdMEAN, x=ANALYSIS_YEAR,ymin=jcdMEAN-jcdSE, ymax=jcdMEAN+jcdSE), width=.2)+
  facet_grid(~REGION, scales = "free_x", space = "free") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        #legend.position = "none",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(angle = 90)) +
  xlab("Year") +
  ylab("Mean Juvenile Density") +
  scale_y_continuous(expand = c(0,0), limits = c(0,15)) +
  geom_text(data=jcd_sumR,aes(x=ANALYSIS_YEAR,y=jcdMEAN+jcdSE,label=jcd_sumR$sig, group = REGION),
            position = position_dodge(),
            vjust = -0.5) +
  geom_hline(yintercept = 15)
p8


#Plotting Delta Density/Year 
delta.sum<-ddply(delta.df,.(REGION),
                summarize,
                DeltaMEAN=mean(DeltaDen,na.rm=T),
                DeltaSE=std.error(DeltaDen,na.rm=T))

#Add Posthoc groupings from LMMs
delta.sum<- delta.sum[order(delta.sum$REGION),];delta.sum
#delta.sum$sig<-c("","","ab","b","c","","","","","","a","b","a","b","","")

delta.sum$REGION <- factor(delta.sum$REGION, levels = c("NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN"))

p9 <- ggplot(delta.sum, aes(x=REGION, y=DeltaMEAN)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve='single'), width = 1, color="black") +
  geom_errorbar(data=delta.sum,aes(y=DeltaMEAN, x=REGION,ymin=DeltaMEAN-DeltaSE, ymax=DeltaMEAN+DeltaSE), width=.2)+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        #legend.position = "none",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(angle = 90)) +
  xlab("Region") +
  ylab(expression("Mean"~Delta~"Juvenile Density/Year"))

  #geom_text(data=jcd_sumR,aes(x=ANALYSIS_YEAR,y=jcdMEAN+jcdSE,label=jcd_sumR$sig, group = REGION),
            #position = position_dodge(),
            #vjust = -0.5)
p9


#Plotting Delta Density/Year 
delta.sumI<-ddply(delta.df,.(REGION,ISLAND),
                 summarize,
                 DeltaMEAN=mean(DeltaDen,na.rm=T),
                 DeltaSE=std.error(DeltaDen,na.rm=T))

barplot1 %>% 
  mutate_if(is.character, as.numeric) %>% 
  ggplot(aes(fct_reorder(X, Y, .desc = TRUE), Y, fill = Group))

p10 <- ggplot(delta.sumI, aes(x=reorder(ISLAND,-DeltaMEAN), y=DeltaMEAN,fill=REGION)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve='single'), width = 1, color="black") +
  geom_errorbar(data=delta.sumI,aes(y=DeltaMEAN, x=ISLAND,ymin=DeltaMEAN-DeltaSE, ymax=DeltaMEAN+DeltaSE), width=.2)+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        #legend.position = "none",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(vjust=0,angle = 90)) +
  xlab("Island") +
  ylab(expression("Mean"~Delta~"Juvenile Density/Year"))

p10

test <- delta.sumI %>%
  arrange(desc(DeltaMEAN)) %>%
  mutate(ISLAND = factor(ISLAND, levels = .$ISLAND))

#Lolipop plot
p11 <- ggplot(test, aes(x=ISLAND, y=DeltaMEAN,color=REGION)) +
  geom_segment(aes(x=ISLAND, xend=ISLAND, y=0, yend=DeltaMEAN) , size=1) +
  geom_point(size=3)+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        #legend.position = "none",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(vjust=0,angle = 90)) +
  #coord_flip() +
  geom_hline(yintercept=0, color = "black")+
  xlab("Island") +
  ylab(expression("Mean"~Delta~"Juvenile Density/Year"))

p11



#Plot delta density by region and depth bin
delta.sumD<-ddply(delta.df,.(REGION,DEPTH_BIN),
                 summarize,
                 DeltaMEAN=mean(DeltaDen,na.rm=T),
                 DeltaSE=std.error(DeltaDen,na.rm=T))

#Add Posthoc groupings from LMMs
#delta.sumD<- delta.sum[order(delta.sumD$REGION),];delta.sumD
#delta.sum$sig<-c("","","ab","b","c","","","","","","a","b","a","b","","")

delta.sumD$REGION <- factor(delta.sumD$REGION, levels = c("NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN"))
delta.sumD$DEPTH_BIN <- factor(delta.sumD$DEPTH_BIN, levels = c("Shallow","Mid","Deep"))

p12 <- ggplot(delta.sumD, aes(x=REGION, y=DeltaMEAN,fill=DEPTH_BIN)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve='single'), width = 1, color="black") +
  geom_errorbar(data=delta.sumD,aes(y=DeltaMEAN, x=REGION,ymin=DeltaMEAN-DeltaSE, ymax=DeltaMEAN+DeltaSE), width=.2)+
  facet_grid(~DEPTH_BIN, scales = "free_x", space = "free") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        #legend.position = "none",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(angle = 90)) +
  xlab("Region") +
  ylab(expression("Mean"~Delta~"Juvenile Density/Year"))
#geom_text(data=jcd_sumR,aes(x=ANALYSIS_YEAR,y=jcdMEAN+jcdSE,label=jcd_sumR$sig, group = REGION),
#position = position_dodge(),
#vjust = -0.5)
p12


p13 <- ggplot(deltaden_lat, aes(x=LATITUDE, y=DeltaDen,color=DeltaDen)) +
  geom_segment(aes(x=LATITUDE, xend=LATITUDE, y=0, yend=DeltaDen) , size=1) +
  geom_point(size=3)+
  geom_point(shape = 1,size = 3,colour = "black")+
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(size = 12),
        legend.position = "bottom",
        axis.line = element_line(color = "black"),
        text = element_text(size = 12),
        axis.text.y = element_text(colour="black"),
        axis.text.x = element_text(vjust=0,angle = 90)) +
  scale_color_gradient2(name=expression(Delta~"Density/Year"),midpoint = 0, low = "firebrick4", mid = "white",
                        high = "royalblue4", space = "Lab" )+
coord_flip() +
  geom_hline(yintercept=0, color = "black")+
  xlab("Latitude") +
  ylab(expression("Mean"~Delta~"Juvenile Density/Year"))

p13


# ggsave(plot=p1,file="T:/Benthic/Projects/Juvenile Project/Figures/Abschange_REGION_points.pdf",width=8,height=6)
# ggsave(plot=p2,file="T:/Benthic/Projects/Juvenile Project/Figures/Abschange_REGION_DEPTH_points.pdf",width=8,height=6)
# ggsave(plot=p3,file="T:/Benthic/Projects/Juvenile Project/Figures/Density_REGION_DEPTH_points.pdf",width=8,height=6)
# ggsave(plot=p4,file="T:/Benthic/Projects/Juvenile Project/Figures/Density_DEPTH_REGION__points.pdf",width=8,height=6)

ggsave(plot=p1,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Abschange_REGION_points.pdf",width=8,height=6)
ggsave(plot=p2,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Abschange_REGION_DEPTH_points.pdf",width=8,height=6)
ggsave(plot=p3,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Density_REGION_DEPTH_points.pdf",width=8,height=6)
ggsave(plot=p4,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Density_DEPTH_REGION__points.pdf",width=8,height=6)
ggsave(plot=p5,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Density_REGION__points.pdf",width=8,height=6)
ggsave(plot=p5.5,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Density_REGION__loess_CI.pdf",width=8,height=6)

ggsave(plot=p7,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Density_Year_Bar_bleaching.pdf",width=9,height=6)
ggsave(plot=p8,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/Density_Year_Bar.pdf",width=9,height=6)
ggsave(plot=p9,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DeltaDensity_Region.pdf",width=9,height=6)
ggsave(plot=p10,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DeltaDensity_island.pdf",width=9,height=6)
ggsave(plot=p11,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DeltaDensity_island_lolliop.pdf",width=9,height=6)
ggsave(plot=p12,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DeltaDensity_RegionDepth.pdf",width=9,height=6)
ggsave(plot=p13,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DeltaDensity_latitude_lolliop.pdf",width=6,height=6)



#General thoughts on patterns
#The time after the bleaching event is very important. I removed the 2016 and 2017 juvenile data for jarvis, baker and howland. it may be interesting to look at these separately


# MIXED MODELING -SPATIAL TEMPORAL PATTERNS -------------------------------
head(jcdG_stS)

#Check for normality and equal variance
library(rcompanion)
#Log transform
plotNormalHistogram(jcdG_stS$JuvColDen)
mod<-lm(JuvColDen~STRATANAME,data=jcdG_stS)
qqnorm(residuals(mod),ylab="Sample Quantiles for residuals")
qqline(residuals(mod), col="red")

jcdG_stS$Den1<-jcdG_stS$JuvColDen+0.5

mod.glm<-glm(Den1~STRATANAME,data=jcdG_stS,family="gaussian"(link='log'))


summary(mod.glm)  # Report the results
par(mfrow = c(2, 2))  # Split the plotting panel into a 2 x 2 grid
plot(mod.glm) 

plotNormalHistogram(jcdG_stS$JuvColDen)
mod<-lm(JuvColDen~STRATANAME,data=jcdG_stS)
qqnorm(residuals(mod),ylab="Sample Quantiles for residuals")
qqline(residuals(mod), col="red")

l<-log(jcdG_stS$JuvColDen+1)
plotNormalHistogram(l)
qqnorm(l, ylab="Sample Quantiles for logDensity")
qqline(l, col="red")
mod<-lm(l~STRATANAME,data=jcdG_stS)
qqnorm(residuals(mod),ylab="Sample Quantiles for residuals")
qqline(residuals(mod), col="red")
jcdG_stS$logDen<-log(jcdG_stS$JuvColDen+1)

summary(mod)  # Report the results
par(mfrow = c(2, 2))  # Split the plotting panel into a 2 x 2 grid
plot(mod) 

#Take home I can either transform or use gamma distribution

#Variance Component Analysis
S<-subset(data.gen_temp,GENUS_CODE=="SSSS")

l<-log(S$JuvColDen+1)
plotNormalHistogram(l)
qqnorm(l, ylab="Sample Quantiles for logDensity")
qqline(l, col="red")
mod<-lm(l~STRATANAME,data=data.gen_temp)
qqnorm(residuals(mod),ylab="Sample Quantiles for residuals")
qqline(residuals(mod), col="red")
S$logDen<-log(S$JuvColDen+1)


S$DEPTH_BIN<-as.factor(S$DEPTH_BIN)
S$STRATANAME<-as.factor(S$STRATANAME)
S$ISLAND<-as.factor(S$ISLAND)
S$DOMAIN_SCHEMA<-as.factor(S$DOMAIN_SCHEMA)
S$REGION<-as.factor(S$REGION)

#Still doesn't work
# fitMM1 <- fitLMM(logDen~(1+(STRATANAME))/(DOMAIN_SCHEMA)/(REGION),S)
# fitMM1
# 
# 
# fit.MS2 <- fitVCA(logDen~STRATANAME/DOMAIN_SCHEMA/ISLAND/REGION,S,method="anova")
# print(fit.MS2, digits=4)

#Need to check with Nyssa or Mary to see if it's ok to extract variance from lmer outputs
mod<-lmer(logDen~1+(1|STRATANAME/DOMAIN_SCHEMA/REGION/OBS_YEAR),data=S)
summary(mod)

mod<-lmer(logDen~1+(1|STRATANAME)+(1|DEPTH_BIN)+(1|DOMAIN_SCHEMA)+ (1|REGION)+ (1|OBS_YEAR),data=S)
summary(mod)

jcdG_stS$ANALYSIS_YEAR<-as.factor(jcdG_stS$ANALYSIS_YEAR)
mod1 <- lmer(logDen~ANALYSIS_YEAR*REGION+(1|ISLAND/SEC_NAME),data=jcdG_stS)

mod2 <- lmer(logDen~ANALYSIS_YEAR+(1|ISLAND/SEC_NAME),data=jcdG_stS)
mod3 <- lmer(logDen~REGION+(1|ISLAND/SEC_NAME),data=jcdG_stS)

modnull <- lmer(logDen~1+(1|SEC_NAME),data=jcdG_stS)
anova(mod1,modnull,test="chisq")
anova(modnull,mod3,test="chisq")
anova(mod2,modnull, test="chisq")

#emmeans(mod1,list(pairwise~ANALYSIS_YEAR+REGION),adjust="Tukey")

#Test for differences between Years for each region
#MHI
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|ISLAND/SEC_NAME),data=subset(jcdG_stS,REGION=="MHI"))
summary(glht(mod1, linfct = mcp(ANALYSIS_YEAR = "Tukey"))) #this works!

#NWHI
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="NWHI"))
summary(glht(mod1, linfct = mcp(ANALYSIS_YEAR = "Tukey"))) #this works!

#PHOENIX
modnull <- lmer(logDen~1+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="PHOENIX"))
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="PHOENIX"))
anova(mod1,modnull,test="chisq")

#LINE
modnull <- lmer(logDen~1+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="LINE"))
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="LINE"))
anova(mod1,modnull,test="chisq")

#Samoa
modnull <- lmer(logDen~1+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="SAMOA"))
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="SAMOA"))
anova(mod1,modnull,test="chisq")

#SMARIAN
modnull <- lmer(logDen~1+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="SMARIAN"))
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="SMARIAN"))
anova(mod1,modnull,test="chisq")

#NMARIAN
modnull <- lmer(logDen~1+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="NMARIAN"))
mod1 <- lmer(logDen~ANALYSIS_YEAR+(1|SEC_NAME),data=subset(jcdG_stS,REGION=="NMARIAN"))
anova(mod1,modnull,test="chisq")



# Summarize Post bleaching data for driver analysis -----------------------

#Subset post bleaching regions and years for downstream driver analysis
REGION_YEAR<-c("MHI_2016","NWHI_2016","NMARIAN_2017","SMARIAN_2017","PHOENIX_2018","LINE_2018","SAMOA_2018")

site.data.gen2$REGION_YEAR<-paste(site.data.gen2$REGION,site.data.gen2$OBS_YEAR,sep="_")

data.gen_pb<-site.data.gen2[site.data.gen2$REGION_YEAR %in% REGION_YEAR,]
head(data.gen_pb)

#Remove strata that have less than 2 sites/stratum
st.list<-ddply(data.gen_pb,.(OBS_YEAR,REGION,ISLAND,SEC_NAME,STRATANAME),summarize,n=length(unique(SITE)))
st.list2<-subset(st.list,n>=2);head(st.list);st.list2<-droplevels(st.list2)
data.gen_pb<-data.gen_pb[data.gen_pb$STRATANAME %in% c(data.gen_pb$STRATANAME),]

View(data.gen_pb) #double check that strata were dropped correctly

#POOL UP
#Set ANALYSIS_SCHEMA to STRATA and DOMAIN_SCHEMA to whatever the highest level you want estimates for (e.g. sector, island, region)
data.gen_pb$ANALYSIS_SCHEMA<-data.gen_pb$STRATANAME
data.gen_pb$DOMAIN_SCHEMA<-data.gen_pb$ISLAND
data.gen_pb$ANALYSIS_YEAR<-data.gen_pb$OBS_YEAR
data.gen_pb$DB_RZ<-paste(data.gen_pb$DEPTH_BIN,data.gen_pb$REEF_ZONE,sep="_")

#Create a vector of columns to subset for strata estimates
c.keep<-c("REGION","ISLAND","ANALYSIS_YEAR","ANALYSIS_SCHEMA","REEF_ZONE","DB_RZ","GENUS_CODE",
          "n_h","N_h","D._h","SE_D._h")

jcdG_st<-Calc_Strata(data.gen_pb,"GENUS_CODE","JuvColDen","Juvpres.abs");jcdG_st=jcdG_st[,c.keep]
colnames(jcdG_st)<-c("REGION","ISLAND","ANALYSIS_YEAR","STRATANAME","REEF_ZONE","DB_RZ","GENUS_CODE","n","Ntot","JuvColDen","SE_JuvColDen")

#Double Check that revised pooling is adding up NH (total sites) correctly
View(jcdG_st)
View(sectors)


#Calculate Island Estimates
jcdG_is<-Calc_Domain(data.gen_pb,"GENUS_CODE","JuvColDen","Juvpres.abs")
jcdG_is<-jcdG_is[,c("REGION","ANALYSIS_YEAR","DOMAIN_SCHEMA","GENUS_CODE","n","Ntot","Mean_JuvColDen","SE_JuvColDen")]

#Calculate Sector Estimates
data.gen_pb$ANALYSIS_SCHEMA<-data.gen_pb$STRATANAME
data.gen_pb$DOMAIN_SCHEMA<-data.gen_pb$SEC_NAME

jcdG_sec<-Calc_Domain(data.gen_pb,"GENUS_CODE","JuvColDen","Juvpres.abs")
jcdG_sec<-jcdG_sec[,c("REGION","ANALYSIS_YEAR","DOMAIN_SCHEMA","GENUS_CODE","n","Ntot","Mean_JuvColDen","SE_JuvColDen")]

# write.csv(jcdG_st,file="T:/Benthic/Projects/Juvenile Project/Response Variables/JuvProject_pb_STRATA.csv")
# write.csv(jcdG_is,file="T:/Benthic/Projects/Juvenile Project/Response Variables/JuvProject_pb_ISLAND.csv")
# write.csv(jcdG_sec,file="T:/Benthic/Projects/Juvenile Project/Response Variables/JuvProject_pb_SECTOR.csv")

write.csv(data.gen_pb,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_pb_SITE.csv")
write.csv(jcdG_st,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_pb_STRATA.csv")
write.csv(jcdG_is,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_pb_ISLAND.csv")
write.csv(jcdG_sec,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Response Variables/JuvProject_pb_SECTOR.csv")


#Plot Juv Density by habitat type

#Identify sites with NA in HABITAT_CODE
data.gen_pb[is.na(data.gen_pb$HABITAT_CODE),]


#Convert habitat codes to a consolidate list of codes

data.gen_pb<-data.gen_pb %>% mutate(HAB_R1=recode(HABITAT_CODE, 
                                     `AGR`="Carbonate Reef",
                                     `APR`="Carbonate Reef",
                                     `APS`="Carbonate Reef",
                                     `WAL`="Carbonate Reef",
                                     `PAV`="Pavement",
                                     `PPR`="Pavement",
                                     `RRB`="Rubble",
                                     `ROB`="Rock & Boulder",
                                     `SAG`="Spur & Groove",
                                     `SCR`="Reef with Sand",
                                     `PSC`="Reef with Sand"))

data.gen_pb<-data.gen_pb %>% mutate(HAB_R2=recode(HABITAT_CODE, 
                                                  `AGR`="Carbonate Reef",
                                                  `APR`="Carbonate Reef",
                                                  `APS`="Carbonate Reef",
                                                  `WAL`="Carbonate Reef",
                                                  `PAV`="Basalt",
                                                  `PPR`="Basalt",
                                                  `RRB`="Rubble",
                                                  `ROB`="Basalt",
                                                  `SAG`="Carbonate Reef",
                                                  `SCR`="Carbonate Reef",
                                                  `PSC`="Basalt"))

data.gen_pb<-data.gen_pb %>% mutate(HAB_COMPLEX=recode(HABITAT_CODE, 
                                                  `AGR`="2",
                                                  `APR`="2",
                                                  `APS`="2",
                                                  `WAL`="2",
                                                  `PAV`="1",
                                                  `PPR`="2",
                                                  `RRB`="3",
                                                  `ROB`="1",
                                                  `SAG`="2",
                                                  `SCR`="2",
                                                  `PSC`="1"))
data.gen_pb$HAB_COMPLEX<-as.numeric(data.gen_pb$HAB_COMPLEX)

hab<-ddply(subset(data.gen_pb,GENUS_CODE=="SSSS"),.(OBS_YEAR,ISLAND,DEPTH_BIN,HABITAT_CODE),
           summarize,
           aveJuvDen=mean(JuvColDen),
           SEJuvDen=std.error(JuvColDen),
           n=length(SITE))

plot2<-ggplot(hab, aes(x=HABITAT_CODE, y=aveJuvDen, fill=DEPTH_BIN)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  # guides(fill=FALSE) 
  facet_wrap(~ISLAND, scales="free_x") +
  geom_errorbar(aes(ymin=aveJuvDen-SEJuvDen, ymax=aveJuvDen+SEJuvDen),width=.15, position=position_dodge(.9))+
  theme_bw() +
  geom_text(data = hab, aes(x = factor(HABITAT_CODE),  y=aveJuvDen+SEJuvDen+5, label = n), position = position_dodge(1), size = 2.25, color = "black", hjust = 'left')+
  theme(
    axis.text.x = element_text(angle = 90)
    ,plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
    ,legend.position="bottom")+
  labs(x="Habitat Code",y="Mean Juvenile Density/m2")

plot2


hab<-ddply(subset(data.gen_pb,GENUS_CODE=="SSSS"),.(OBS_YEAR,REGION,DEPTH_BIN,HAB_R1),
           summarize,
           aveJuvDen=mean(JuvColDen),
           SEJuvDen=std.error(JuvColDen),
           n=length(SITE))

hab2<-ggplot(hab, aes(x=HAB_R1, y=aveJuvDen, fill=DEPTH_BIN)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  # guides(fill=FALSE) 
  facet_wrap(~REGION, scales="free_x") +
  geom_errorbar(aes(ymin=aveJuvDen-SEJuvDen, ymax=aveJuvDen+SEJuvDen),width=.15, position=position_dodge(.9))+
  geom_text(data = hab, aes(x = factor(HAB_R1),  y=aveJuvDen+SEJuvDen+5, label = n), position = position_dodge(1), size = 2.25, color = "black", hjust = 'left')+
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90)
    ,plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
    ,legend.position="bottom")+
  labs(x="Habitat Code",y="Mean Juvenile Density/m2")

hab2

hab<-ddply(subset(data.gen_pb,GENUS_CODE=="SSSS"),.(OBS_YEAR,REGION,DEPTH_BIN,HAB_R2),
           summarize,
           aveJuvDen=mean(JuvColDen),
           SEJuvDen=std.error(JuvColDen),
           n=length(SITE))

hab3<-ggplot(hab, aes(x=HAB_R2, y=aveJuvDen, fill=DEPTH_BIN)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  # guides(fill=FALSE) 
  facet_wrap(~REGION, scales="free_x") +
  geom_errorbar(aes(ymin=aveJuvDen-SEJuvDen, ymax=aveJuvDen+SEJuvDen),width=.15, position=position_dodge(.9))+
  geom_text(data = hab, aes(x = factor(HAB_R2),  y=aveJuvDen+SEJuvDen+2, label = n), position = position_dodge(1), size = 2.25, color = "black", hjust = 'left')+
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90)
    ,plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
    ,legend.position="bottom")+
  labs(x="Habitat Code",y="Mean Juvenile Density/m2")

hab3

ggsave(plot=hab2,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DensityvGeneralHabtype1.pdf",width=8,height=8)
ggsave(plot=hab3,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DensityvGeneralHabtype2.pdf",width=8,height=8)



#Take home: There really is no diserable differences across habitat and regions that would allow me to convert habitat to continuous variable

#Tried plotting density vs. general habitat complexity based on habitat code- nope, don't use this method
hab<-ddply(data.gen_pb,.(OBS_YEAR,REGION,DEPTH_BIN,GENUS_CODE,STRATANAME),
           summarize,
           aveJuvDen=mean(JuvColDen),
           habcomplex=mean(HAB_COMPLEX))

habS<-subset(hab,GENUS_CODE=="SSSS")

hab4<-habS %>%
  mutate(DEPTH_BIN = fct_relevel(DEPTH_BIN,"Shallow","Mid","Deep")) %>% #reorder varibles
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=habcomplex, y=aveJuvDen, color=REGION)) + 
  geom_smooth(se=FALSE,method="loess",lwd=1.5)+
  geom_point()+
  facet_wrap(~DEPTH_BIN)+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Year",y="Abs. Change Mean Density")
p2


#plot Juvenile density v. depth (continuous)
d<-subset(data.gen_pb,GENUS_CODE=="SSSS")

jvd<-d %>%
  mutate(REGION = fct_relevel(REGION,"NWHI","MHI","PHOENIX","LINE","SAMOA","SMARIAN","NMARIAN")) %>% #reorder varibles 
  ggplot(aes(x=MAX_DEPTH_M, y=JuvColDen, color=REGION)) + 
  geom_smooth(se=TRUE,method="lm",lwd=1.5)+
  geom_point()+
  facet_wrap(~REGION,scales="free_y")+
  theme_bw() +
  theme(
    plot.background = element_blank()
    ,panel.grid.major = element_blank()
    ,panel.grid.minor = element_blank()
    ,axis.ticks.x = element_blank() # no x axis ticks
    ,axis.title.x = element_text( vjust = -.0001)
    ,axis.text.x = element_text(angle = 90)) + # adjust x axis to lower the same amount as the genus labels
  labs(x="Max Depth(M)",y="Juvenile Density")
jvd

ggsave(plot=jvd,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DensityvDepth_loess.pdf",width=8,height=8)
ggsave(plot=jvd,file="C:/Users/Courtney.S.Couch/Documents/Courtney's Files/R Files/ESD/Juvenile Project/Figures/DensityvDepth_lm.pdf",width=8,height=8)

#There are 2 FFS forereef sites that have very high Acropora juvenile density. I confirmed this is accurate from the photoquads.

