```{r} 
rm(list = ls()) # clear workspace
library(tidyverse)

## LOAD: Site visit table from Oracle database that has sectors defined to each site (by Kisei)
raw<-read.csv("T:/Benthic/Data/REA Coral Demography & Cover/RA2301_Leg3_SITE_VISIT_DATA.csv") 

# Only OCC sites with photoquads / SfM  (May want to eventually include all OCC sites into survey master- this will be a bigger lift)
sv <- raw %>% filter(!(TYPE %in% c("Oceanography") & PHOTOMOSAIC_YN == "NO" & TRANSECT_PHOTOS == "NO"))

## QC
sv %>% distinct(TYPE, PHOTOMOSAIC_YN, TRANSECT_PHOTOS, CB_ACTIVITY_YN, FISH_REA_YN) %>% arrange(TYPE)


## CLEANUP
colnames(sv)[colnames(sv)=="MAX_DEPTH_M"]<-"new_MAX_DEPTH_M"
colnames(sv)[colnames(sv)=="MIN_DEPTH_M"]<-"new_MIN_DEPTH_M"
colnames(sv)[colnames(sv)=="LONGITUDE_LOS"]<-"LONGITUDE_LOV"
colnames(sv)[colnames(sv)=="LATITUDE_LOS"]<-"LATITUDE_LOV"

## INDICATORS OF SITE TYPE
sv.final <- sv %>% mutate(Benthic = ifelse(TYPE == "Benthic", 1, 0)) %>% 
  mutate(Fish = ifelse(TYPE == "Fish" & FISH_REA_YN == "YES", 1, 0)) %>%
  mutate(Oceanography = ifelse(TYPE == "Oceanography", 1, 0)) %>%
  mutate(CAU = ifelse(CAUS_DEPLOY_YN == "YES", 1, 0))

# Ivor's script -- additional columns in previous years
#df[df$TYPE %in% c("ARMS Only", "ARMS"),]$TYPE<-"ARMS"
#df[df$TYPE %in% c("Benthic Only", "Benthic", "Benthic & CAU"),]$TYPE<-"Benthic"
#df[df$TYPE %in% c("CAU Only", "CAU"),]$TYPE<-"CAU"
#df[df$TYPE %in% c("Oceanography Only", "Oceanography", "Oteam Only"),]$TYPE<-"Oceanography"
#df[df$TYPE %in% c("Fish Only", "Fish"),]$TYPE<-"Fish"
#df[df$TYPE %in% c("Benthic & Fish", "Both"),]$TYPE<-"Both"
 

```

## SECTOR ASSIGNMENTS SHOULD BE QCed BY BENTHIC & FISH 
# ArcGIS: (1) load sitevisit file and plot lat/longs per site onto map (color code by depth bin); filter so only plotting fish sites!
#         (2) check sector assignments w/ sector & reef zone shapefiles: https://docs.google.com/spreadsheets/d/1ubvirPEe6gf9Ub-KEIw9bThGtvlkvzY5_09mdaUtlQo/edit?pli=1#gid=0
#         (3) compare numbers per sector-reef zone-depth bin with targeted allocation & determine sector assignments to sites on the edge of 2 sectors, etc.

sv.final$PERM_SITE<-0
sv.final$OLD_SITE<-NA
sv.final$benth<-1
sv.final$fish<-0
sv.final$ARMS<-0
sv.final$microb<-0
sv.final$arms_r<-0
sv.final$arms_d<-0
sv.final$HUMANS20<-NA 
sv.final$HUMANS200<-NA 
sv.final$TYPE<- "RANDOM"
sv.final$ANALYSIS_SCHEME<-"RAMP_BASIC"
sv.final$bANALYSIS_SCHEME<-"RAMP_BASIC"
sv.final$ANALYSIS_YEAR<-"2023"
sv.final$TUT2012<-NA
sv.final$OTHER_AREA_GROUPING<-NA
sv.final$SPECIAL_PROJ_YN<-NA
sv$SPECIAL_PROJ_DESCRIPTION<-NA
sv.final$OBS_YEAR<-"2023"




```

## PREPARE & MERGE SITEVISIT WITH SURVEY MASTER --> NOTE, used some code from Ivor's Update SurveyMaster script
```{r} 

# COMPARE SEC_NAME with Sectors-Strata-Areas file & SurveyMaster
sectors<-read.csv("C:/Users/courtney.s.couch/Documents/GitHub/fish-paste/data/Sectors-Strata-Areas.csv", stringsAsFactors=FALSE)
SM <- read.csv("C:/Users/courtney.s.couch/Documents/GitHub/fish-paste/data/SURVEY MASTER.csv") # load most recent SURVEY MASTER

# Marianas sectors
sv.ready %>% distinct(ISLAND, SEC_NAME) %>% mutate(doc = "sm.22") %>% 
  bind_rows(sectors %>% filter(REGION == "MARIAN") %>% distinct(ISLAND, SEC_NAME) %>% mutate(doc = "sec")) %>%
  bind_rows(SM %>% filter(REGION == "MARIAN" & OBS_YEAR > 2009) %>% distinct(ISLAND, SEC_NAME) %>% mutate(doc = "SM")) %>% arrange(ISLAND, SEC_NAME) %>% 
  # create summary table
  mutate(ISLAND = "x") %>% spread(doc, ISLAND) # NEED TO UPDATE!

# Hawaii & Tutuila sectors
sv.ready %>% filter(REGION != "MARIAN") %>% distinct(ISLAND, SEC_NAME) %>% mutate(doc = "sm.22") %>% 
  bind_rows(sectors %>% filter(ISLAND %in% c("Hawaii", "Tutuila")) %>% distinct(ISLAND, SEC_NAME) %>% mutate(doc = "sec")) %>%
  bind_rows(SM %>% filter(ISLAND %in% c("Hawaii", "Tutuila") & OBS_YEAR > 2009) %>% distinct(ISLAND, SEC_NAME) %>% mutate(doc = "SM")) %>% arrange(ISLAND, SEC_NAME) %>% 
  # create summary table
  mutate(ISLAND = "x") %>% spread(doc, ISLAND) # GOOD TO GO!

# FIX SEC_NAME for consistency
sv.sec <- sv.ready %>% mutate(SEC_NAME = ifelse(ISLAND != "Guam" & REGION == "MARIAN", ISLAND, # use ISLAND spelling for non-Guam SEC_NAME
                                                ifelse(SEC_NAME == "GUA_PATI_PT", "GUA_PATI_POINT", # fix 2 Guam sectors
                                                ifelse(SEC_NAME == "GUA_TUMON_BAY", "GUA_TUMON", SEC_NAME))))


# compare column names with those in SURVEYMASTER
sv.sec[,order(colnames(sv.sec))] %>% names()

# MISSING FROM SITEVISIT:
# OLD_SITE, OCC_SITEID, PERM_SITE, benth, fish, arms_d, arms_r, microb, ARMS, HUMANS20, HUMANS200, TYPE = RANDOM, FIXED, Haphazard, NA, BAD HABITAT, bANALYSIS_SCHEME, ANALYSIS_YEAR, TUT2012, OTHER_AREA_GROUPING

# CHECK OCC SITE COLUMNS
sv.sec %>% distinct(ASSOC_OCC_SITEID, OCC_SITEID)
sv.sec %>% filter(!is.na(ASSOC_OCC_SITEID) & !is.na(OCC_SITEID)) # when values in both columns, they're the same SITEID

## CLEAN UP
sv.final <- sv.sec %>% 
# TRANSLATED FROM IVOR'S Update SurveyMaster SCRIPT:
  
  # EXTRACT year from date-time
  separate(DATE_, c("X_", "X_2"), sep = " ", remove = FALSE) %>% separate(X_, c("X_3", "X_4", "X_5"), sep = "/", remove = FALSE) %>% 
  mutate(OBS_YEAR = as.integer(X_5)) %>% select(-starts_with("X_")) %>% 
  # PAD site IDs with 0s as needed (5-digit numbers after dash) --> dplyr version of SiteNumLeadingZeros function in core_functions
  mutate(OLD_SITE = SITE) %>% 
  separate(SITE, c("X_", "X_2"), sep = "-", remove = FALSE) %>% mutate(X_3 = ifelse(nchar(X_2) < 5, str_pad(X_2, 5, side = "left", pad = "0"))) %>% 
  unite("SITE", X_, X_3, sep = "-", remove = TRUE) %>% select(-starts_with("X_")) %>%
  # CREATE 0-1 indicators of activities --> 0 = NO / 1 = YES (Note: columns ARMS, Benthic, CAU, Fish, Oceanography already 0-1s)
  mutate(benth = ifelse(CORAL_BELT_ADULT_YN == "YES" | CORAL_BELT_JUVENILE_YN == "YES", 1, 0)) %>% # other possible column: LPI_YN
  mutate(fish = ifelse(FISH_REA_YN == "YES", 1, 0)) %>%
#  mutate(arms_d = ifelse(ARMS_DEPLOY_YN == "YES", 1, 0)) %>%
#  mutate(arms_r = ifelse(ARMS_RECOVERED == "YES" | ARMS_RETRIEVE_YN == "YES", 1, 0)) %>%
  mutate(cau_d = ifelse(CAUS_DEPLOY_YN == "YES", 1, 0)) %>% # other possible column: CAUS_DEPLOYED
  mutate(cau_r = ifelse(CAUS_RETRIEVE_YN == "YES", 1, 0)) %>%   # other possible column: CAUS_RECOVERED
#  mutate(microb = ifelse(MICROBIAL_SAMPLE == "YES", 1, 0)) %>%
  
# TLK ADDITIONAL CLEANING

  # COMBINE assoc_OCC with OCC_siteID
  mutate(OCC_SITEID = ifelse(is.na(OCC_SITEID) & !is.na(ASSOC_OCC_SITEID), ASSOC_OCC_SITEID, OCC_SITEID)) %>% # NOTE: even though repeating OCC_SITEIDs, they each have a unique SITEVISITID
  # RECODE YN columns into -1-0-1 indicators
  mutate_at(vars(CLIMATE_STATION_YN, PHOTOMOSAIC_YN, TRANSECT_PHOTOS), ~ifelse(. == "YES", 0, -1)) %>% #?????
  
  # TYPE as survey site type (e.g., Haphazard, Fixed, Random, etc.) ????? 

  # REMOVE columns NOT in SurveyMaster
  select(-ASSOC_OCC_SITEID, -contains("DEPLOY"), -contains("RETRIEVE"), -contains("ACTIVITY_"), -contains("COMMENTS_"), -contains("CORAL_"), -DISTRICT, -DIVE, -FISH_REA_YN, -LOCALTIME, 
        -contains("_Z_"), -contains("OBJECTID_"), -SECTOR, -SITEDESCRIPTION, -VISIBILITY, -VISIBILITY_M)
      

## ADD LATEST SITES TO SURVEY MASTER
SM.full <- SM %>% bind_rows(sv.final %>% mutate_at(vars(SPECIAL_PROJ_YN), ~as.character(.)))

sm.final <- SM.full %>% filter(OBS_YEAR == 2022) %>% 
  # TURN NAs into 0-1 indicators
  mutate_at(vars(arms_d, arms_r, microb, ARMS), ~ifelse(is.na(.), 0, 1)) %>% 
  # COMPLETE analysis year
  mutate(ANALYSIS_YEAR = as.character(OBS_YEAR)) %>%
  # FISH --> add RAMP_BASIC scheme
  mutate(ANALYSIS_SCHEME = ifelse(is.na(ANALYSIS_SCHEME) & Fish == 1, "RAMP_BASIC", ANALYSIS_SCHEME)) %>% 

  # add back in rest of sites
  bind_rows(SM.full %>% filter(OBS_YEAR != 2022)) %>% arrange(SITEVISITID) %>%
  
  # reorder columns
  dplyr::relocate(SEC_NAME, REEF_ZONE, DEPTH_BIN, new_MIN_DEPTH_M, new_MAX_DEPTH_M, .after = ISLAND) %>%
  dplyr::relocate(ROUNDID, MISSIONID, .after = SITEVISITID) %>%
  dplyr::relocate(LATITUDE_SV, LONGITUDE_SV, LATITUDE_LOV, LONGITUDE_LOV, .after = OCC_SITEID) %>%
  dplyr::relocate(ANALYSIS_YEAR, .after = OBS_YEAR)

## CHECK for consistent SEC_NAME


write.csv(sm.final, "C:/Users/tye.kindinger/Desktop/SM_fish_2022.csv")
```


#### 2022 FISH DATA --> include ALL REA/SPC surveys conducted in 2022 (will filter out non-NCRMP in scripts)
```{r} 
rm(list = ls()) # clear workspace
library(tidyverse)

fish <- read.csv("C:/Users/tye.kindinger/Desktop/2022_Fish_data.csv") # load most recent fish data --> 37,274 rows
fish %>% distinct(SITEVISITID) # 321 sites

sm <- read.csv("C:/Users/tye.kindinger/Desktop/SM_fish_2022.csv") %>% filter(OBS_YEAR == 2022 & Fish == 1)  # load most recent survey master
sm %>% distinct(SITEVISITID) # 321 sites

## QC FISH DATA based on findings above while QCing SM

# merge sm and check for sites that should be removed: 
# (1) REMOVE 5 sites that are TYPE = Fish but are only water sampling --> SITEVISITID %in% c(38167, 38168, 38404, 38405,38406) 
# (2) REMOVE 1 CB site (not Fish REA or benthic PQ/SfM) --> SITEVISITID = 39740
# (3) REMOVE 1 site that doesn't have any data (survey was incomplete) --> SITEVISITID = 39522
# (4) REMOVE 1 site that was an error (never existed) --> SITEVISITID = 39740

fish.sm <- fish %>% select(-DATE_) %>%  # all rows have EXCLUDE_FLAG = 0 (keep) --> use QCed exclude column from SM!
  left_join(sm %>% select(SITEVISITID, DATE_, SEC_NAME, EXCLUDE_FLAG, starts_with("SPECIAL")), by = c("SITEVISITID")) %>% # use SM DATE_ because still in number format of dates
  # CLEAN UP date formatting for merging with ongoing dataset --> POSIXct %m/%d/%Y	
  separate(DATE_, c("DATE", "X_TIME"), sep = " ", remove = FALSE) %>% mutate(DATE2 = as.POSIXct(DATE, format = "%m/%d/%Y")) %>% select(-DATE_, -DATE, -X_TIME) %>% dplyr::rename(DATE_ = DATE2)

# checks
sm %>% left_join(fish.sm %>% distinct(SITEVISITID) %>% mutate(x = "Y"), by = c("SITEVISITID")) %>% filter(is.na(x)) # sites in SM but missing from fish data --> OK!
fish.sm %>% select(EXCLUDE_FLAG, starts_with("SPECIAL")) %>% distinct() # GuamMPA sites look good
fish.sm %>% filter(SPECIAL_PROJ_YN == "-1") %>% group_by(SEC_NAME, DEPTH_BIN, EXCLUDE_FLAG) %>% dplyr::summarise(n = n_distinct(SITEVISITID)) %>% arrange(SEC_NAME, EXCLUDE_FLAG) # GOOD!
# GUA_WEST_OPEN: deep = 3, mid = 5, shallow = 5 | GUA_PITI_BOMB: deep = 5, mid = 4, shallow = 6
fish.sm %>% filter(SITEVISITID %in% c(38167, 38168, 38404, 38405, 38406, 39740, 39522, 39740))  # specific sites that needed to be removed (listed above) --> GOOD! Not included / no fish data

sm %>% filter(OBS_YEAR == 2022 & Fish == 1 & EXCLUDE_FLAG == 0) %>% distinct(SITEVISITID)  # 297 sites
fish.sm %>% filter(EXCLUDE_FLAG == 0) %>% distinct(SITEVISITID) # 297 sites
# all NCRMP sites present!

# SAVE
write.csv(fish.sm, "C:/Users/tye.kindinger/Desktop/FISH TEAM/Post-cruise workings/2022_Marianas/2022 Fish data/fishdata_2022.csv")


## COMBINE WITH REST OF FISH DATA
load("C:/Users/tye.kindinger/Desktop/FISH TEAM/fish-paste/data/DEFUNCT files/defunct_pre2022_ALL_REA_FISH_RAW.rdata")
df # 988,383 rows

# NAME df SO CONSISTENT WITH FISH SCRIPTS!!
df <- fish.sm %>% # 37,274 rows
  ## UPDATE columns so consistent with earlier datasets/scripts
  mutate_if(sapply(., is.character), as.factor) %>% 
  # clean up remaining
  mutate_at(vars(OTHER_TYPE), ~as.factor(.)) %>% 
  mutate_at(vars(SPECIAL_PROJ_YN), ~as.integer(.)) %>%
  mutate_at(vars(HARD_CORAL, SOFT_CORAL, MA, CCA, TA, SAND, TUNICATE, ZOANTHID, CORALLIMORPH, CLAM, CYANO, SPONGE, OTHER, starts_with("SUBSTRATE_HEIGHT_")), ~as.numeric(.)) %>%
  # ADD prior data
  bind_rows(df) # 988,383 rows

# 1,025,657 rows

# SAVE
save(df, file = "C:/Users/tye.kindinger/Desktop/FISH TEAM/fish-paste/data/ALL_REA_FISH_RAW.RData")
  
```

