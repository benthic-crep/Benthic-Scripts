# tab_model(mod2)
#
# #Model Selection
#
# glmerDensity<-function(d,grouping_field="GENUS_CODE",genus_field="SSSS",metric_field="AdColCount"){
#   d$GROUP<-d[,grouping_field]
#   d$METRIC<-d[,metric_field]
#   s<-subset(d,GROUP==genus_field)
#
#   Cand.set <- list( )
#   Cand.set[[1]]<-glmer(METRIC~1 + (1|ISLAND/SEC_NAME),family=poisson,data=s)
#   Cand.set[[2]]<-glmer(METRIC~METHOD + (1|ISLAND/SEC_NAME),family=poisson,data=s)
#   Cand.set[[4]]<-glmer(METRIC~METHOD*MAX_DEPTH_M + (1|ISLAND/SEC_NAME),family=poisson,data=s,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=200000)))
#   Cand.set[[5]]<-glmer(METRIC~METHOD*HAB_R1 + (1|ISLAND/SEC_NAME),family=poisson,data=s,control=glmerControl(optimizer="Nelder_Mead",optCtrl=list(maxfun=200000)))
#
#   Modnames <- c("Null","Method","Method + Depth","Method + Habitat")
#   ##generate AICc table
#   aictab(cand.set = Cand.set, modnames = Modnames, sort = TRUE)
#   ##round to 4 digits after decimal point and give log-likelihood
#   print(aictab(cand.set = Cand.set, modnames = Modnames, sort = TRUE),
#         digits = 3, LL = TRUE)
#
#   a<-r.squaredGLMM(Cand.set[[1]])
#   b<-r.squaredGLMM(Cand.set[[2]])
#   c<-r.squaredGLMM(Cand.set[[3]])
#   d<-r.squaredGLMM(Cand.set[[4]])
#   e<-r.squaredGLMM(Cand.set[[5]])
#
#   print(a);print(b);print(c);print(d);print(e)
#
# }
#
# #Adults
# glmerDensity(site,"GENUS_CODE","SSSS","AdColCount")
# glmerDensity(site,"GENUS_CODE","POSP","AdColCount")
# glmerDensity(site,"GENUS_CODE","MOSP","AdColCount")
# glmerDensity(site,"GENUS_CODE","POCS","AdColCount")
#
# glmerDensity(site,"GENUS_CODE","SSSS","JuvColDen")
# glmerDensity(site,"GENUS_CODE","POSP","JuvColDen")
# glmerDensity(site,"GENUS_CODE","MOSP","JuvColDen")
# glmerDensity(site,"GENUS_CODE","POCS","JuvColDen")
#Adult Colony Density- sqrt transform
#also tried gamma and neg binomial- sqrt transform is best
s<-subset(site,GENUS_CODE=="SSSS")
hist(log(s$AdColDen))
s$sqAdColDen<-sqrt(s$AdColDen)
m<-lmer(sqAdColDen~METHOD + (1|SEC_NAME),data=s)
m<-lm(length~model,data=s)
DPlots<-function(m,s){
par(mfrow=c(2,2)) # make the subplots
qqnorm(resid(m))
E2<-resid(m, type = "response") # extract normalized residuals
F2<-fitted(m) # extract the fitted data
plot(F2, E2, xlab = "fitted values", ylab = "residuals") # plot the relationship
abline(h = 0, lty = 2) # add a flat line at zerp
# test for homogeneity of variances
boxplot(E2~s$SEC_NAME, ylab = "residuals")
# check for independence. There should be no pattern
plot(E2~s$METHOD, ylab = 'residuals', xlab = "METHOD")
}
DPlots(m,s)
full.form <- formula(sqAdColDen ~ METHOD*MAX_DEPTH_M*HAB_R1, data=s)
#fit lme using "ML"= maximum likelihood - so can use step fxn
full.lme <-lme(full.form, data=s, random=~1|SEC_NAME, method="ML") #use if needed
#drop 3-way interaction term
FULL.MOD <- update(full.lme, .~. -METHOD:MAX_DEPTH_M:HAB_R1)
FULL.MOD <- update(FULL.MOD, .~. -MAX_DEPTH_M:HAB_R1)
anova(FULL.MOD) #from output, drop the 2-way interaction term with the larger p-value first
RED.MOD1 <- update(FULL.MOD, .~. -METHOD:HAB_R1) #drop 2-way interaction term
anova(FULL.MOD, RED.MOD1) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD2 <- update(RED.MOD1, .~. -METHOD:MAX_DEPTH_M) #drop 2-way interaction term
anova(RED.MOD1, RED.MOD2) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD3 <- update(RED.MOD2, .~. -METHOD) #drop 2-way interaction term
anova(RED.MOD2, RED.MOD3) #LRT --> move forward w/ whichever model keeps/removes term
#Extract predicted values for Adult density
#https://aosmith.rbind.io/2018/11/16/plot-fitted-lines/
library(nlme)
mod<-lme(sqAdColDen~METHOD*MAX_DEPTH_M, random = ~1|SEC_NAME,data=s)
newdat.lme = data.frame(METHOD = s$METHOD,
MAX_DEPTH_M = rep(seq(0,30,by=0.29),2),
SEC_NAME = s$SEC_NAME)
head(newdat.lme)
newdat.lme$predlme <- predict(mod, newdata = newdat.lme, level=0)
newdat.lme$AdColDen<-newdat.lme$predlme^2 #back transform predicted values
des = model.matrix(formula(mod)[-2], newdat.lme)
predvar = diag( des %*% vcov(mod) %*% t(des) )
newdat.lme$lower = with(newdat.lme, predlme - 2*sqrt(predvar) )
newdat.lme$upper = with(newdat.lme, predlme + 2*sqrt(predvar) )
newdat.lme$lower<-newdat.lme$lower^2 #back transform predicted values
newdat.lme$upper<-newdat.lme$upper^2 #back transform predicted values
s.wide<-subset(site.wide,GENUS_CODE=="SSSS")
Plot1to1_new<-function(d,response_variable,predictor_variable,r_name,p_name){
#sub<-d[d$taxon,]
d$Y<-d[,response_variable]
d$X<-d[,predictor_variable]
mx_val<-max(d$Y, d$X, na.rm = TRUE)
corr<-cor.test(d$X, d$Y, method="pearson")
rmse<-rmse(d$Y, d$X,na.rm=TRUE)
r_text<-paste("RMSE = ", round(rmse,digits = 2),"\n r = ", round((corr$estimate),2), sep="")
p1<-ggplot(d, aes(x=X, y=Y)) +
geom_point(size=1) + 	geom_abline(slope=1, intercept=0) +
geom_smooth(method="lm", color="red", linetype="dashed", se=F) +
geom_label(aes((mx_val/5), (mx_val * 0.9), label=r_text), nudge_y=-0.1, nudge_x=1,label.size=0.35, color="black", fill="white") +
theme_bw()+
theme(panel.grid.major = element_blank()
,panel.grid.minor = element_blank())+
scale_x_continuous(limits=c(0,mx_val)) +
scale_y_continuous(limits=c(0,mx_val)) +
ylab(r_name) +  xlab(p_name)
return(p1)
} #
PlotMethod<-function(d,grouping_field,metric_field,genus_field,metric_name,x,y,siglabel){
d$GROUP<-d[,grouping_field]
d$METRIC<-d[,metric_field]
s<-subset(d,GROUP==genus_field)
p<-ggplot(s, aes(x=METHOD, y=METRIC, fill=METHOD)) +
geom_boxplot() +
geom_label(label=siglabel, x=x,y=y,label.size = 0.35,color = "black", fill="white")+
theme_bw() +
theme(
axis.text.x = element_text(angle = 0)
,plot.background = element_blank()
,panel.grid.major = element_blank()
,panel.grid.minor = element_blank()
,axis.ticks.x = element_blank() # no x axis ticks
,axis.title.x = element_text( vjust = -.0001)
,legend.position="none")+ # adjust x axis to lower the same amount as the genus labels
labs(x="Method",y=metric_name)
return(p)
}
PlotHabitat<-function(d,grouping_field,metric_field,genus_field,metric_name,x,y,siglabel){
d$GROUP<-d[,grouping_field]
d$METRIC<-d[,metric_field]
s<-subset(d,GROUP==genus_field)
p<-ggplot(s, aes(x=HAB_R1, y=METRIC, fill=METHOD)) +
geom_boxplot() +
theme_bw() +
geom_label(label=siglabel, x=x,y=y,label.size = 0.35,color = "black", fill="white")+
theme(
axis.text.x = element_text(angle = 90)
,plot.background = element_blank()
,panel.grid.major = element_blank()
,panel.grid.minor = element_blank()
,axis.ticks.x = element_blank() # no x axis ticks
,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
,legend.position="none")+
labs(x="Habitat Type",y=metric_name)
return(p)
}
PlotDepth<-function(d,grouping_field,metric_field,metric_field2,genus_field,metric_name,x,y,siglabel){
d$GROUP<-d[,grouping_field]
d$METRIC<-d[,metric_field]
newdat.lme$METRIC2<-newdat.lme[,metric_field2]
s<-subset(d,GROUP==genus_field)
p<-ggplot(s, aes(x = MAX_DEPTH_M, y = METRIC, color = METHOD) ) +
geom_point(aes(colour = factor(METHOD))) +
geom_line(data = newdat.lme, aes(y = METRIC2), size = 1)+
geom_ribbon(data = newdat.lme, aes(y = NULL, ymin = lower, ymax = upper,
color = NULL, fill = METHOD),alpha = .15)+
geom_label(label=siglabel, x=x,y=y,label.size = 0.35,color = "black", fill="white")+
theme_bw() +
theme(
axis.text.x = element_text(angle = 0)
,plot.background = element_blank()
,panel.grid.major = element_blank()
,panel.grid.minor = element_blank()
,axis.ticks.x = element_blank() # no x axis ticks
,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
,legend.position="none")+
labs(x="Max Depth (m)",y=metric_name)
return(p)
}
p1<-Plot1to1_new(s.wide,"SfM_AdColDen","Diver_AdColDen","SfM Adult Density","Diver Adult Density")
p2<-PlotMethod(site,"GENUS_CODE","AdColDen","SSSS","Adult Density",1.5,28,"NS")
p3<-PlotHabitat(site,"GENUS_CODE","AdColDen","SSSS","Adult Density",3,28,"Method x Habitat NS")
p4<-PlotDepth(site,"GENUS_CODE","AdColDen","AdColDen","SSSS","Adult Density",15,28,"Method x Depth NS")
AdColDenS<-grid.arrange(p1,p2,p3,p4,nrow=2,ncol=2)
ggsave(plot<-AdColDenS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/AdColDenSSSS_stats.png",width=8,height=6)
# #Rather than setting up complicated contrasts to test for dif between methods within habitats
# #Run separate models for each habitat then run multiple test corrections
# a<-summary(glht(lmer(sqAdColDen~METHOD + (1|SEC_NAME),data=subset(s,HAB_R1=="Aggregate Reef")),linfct=mcp(METHOD="Tukey")))
# b<-summary(glht(lmer(sqAdColDen~METHOD + (1|SEC_NAME),data=subset(s,HAB_R1=="Pavement")),linfct=mcp(METHOD="Tukey")))
# c<-summary(glht(lmer(sqAdColDen~METHOD + (1|SEC_NAME),data=subset(s,HAB_R1=="Patch Reef")),linfct=mcp(METHOD="Tukey")))
# d<-summary(glht(lmer(sqAdColDen~METHOD + (1|SEC_NAME),data=subset(s,HAB_R1=="Rock & Boulder")),linfct=mcp(METHOD="Tukey")))
# e<-summary(glht(lmer(sqAdColDen~METHOD + (1|SEC_NAME),data=subset(s,HAB_R1=="Rubble")),linfct=mcp(METHOD="Tukey")))
#
# #Extract values and adjust for multiple tests-
# pval<-c(a$test$pvalues,b$test$pvalues,c$test$pvalues,d$test$pvalues,e$test$pvalues)
# p.adjust(pval,"BH")
#
# lsmeans(mod6,~ MH)
# tmp <-emmeans(mod6, pairwise ~ METHOD | HAB_R1)
#Juvenile Colony Density- sqrt transform
#also tried gamma and neg binomial- sqrt transform is best
s<-subset(site,GENUS_CODE=="SSSS")
hist(sqrt(s$JuvColDen))
s$sqJuvColDen<-sqrt(s$JuvColDen)
m<-lmer(sqJuvColDen~METHOD + (1|SEC_NAME),data=s)
DPlots(m,s)
full.form <- formula(sqJuvColDen ~ METHOD*MAX_DEPTH_M*HAB_R1, data=s)
#fit lme using "ML"= maximum likelihood - so can use step fxn
full.lme <-lme(full.form, data=s, random=~1|SEC_NAME, method="ML") #use if needed
#drop 3-way interaction term & depth x habitat (not interested in these hypotheses)
FULL.MOD <- update(full.lme, .~. -METHOD:MAX_DEPTH_M:HAB_R1)
FULL.MOD <- update(FULL.MOD, .~. -MAX_DEPTH_M:HAB_R1)
anova(FULL.MOD) #from output, drop the 2-way interaction term with the larger p-value first
RED.MOD1 <- update(FULL.MOD, .~. -METHOD:HAB_R1) #drop 2-way interaction term
anova(FULL.MOD, RED.MOD1) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD2 <- update(RED.MOD1, .~. -METHOD:MAX_DEPTH_M) #drop 2-way interaction term
anova(RED.MOD1, RED.MOD2) #LRT --> move forward w/ whichever model keeps/removes term
#Extract predicted values for Adult density
#https://aosmith.rbind.io/2018/11/16/plot-fitted-lines/
library(nlme)
mod<-lme(sqJuvColDen~METHOD*MAX_DEPTH_M, random = ~1|SEC_NAME,data=s)
newdat.lme = data.frame(METHOD = s$METHOD,
MAX_DEPTH_M = rep(seq(0,30,by=0.29),2),
SEC_NAME = s$SEC_NAME)
head(newdat.lme)
newdat.lme$predlme <- predict(mod, newdata = newdat.lme, level=0)
newdat.lme$JuvColDen<-newdat.lme$predlme^2 #back transform predicted values
des = model.matrix(formula(mod)[-2], newdat.lme)
predvar = diag( des %*% vcov(mod) %*% t(des) )
newdat.lme$lower = with(newdat.lme, predlme - 2*sqrt(predvar) )
newdat.lme$upper = with(newdat.lme, predlme + 2*sqrt(predvar) )
newdat.lme$lower<-newdat.lme$lower^2 #back transform predicted values
newdat.lme$upper<-newdat.lme$upper^2 #back transform predicted values
p1<-Plot1to1_new(s.wide,"SfM_JuvColDen","Diver_JuvColDen","SfM Juvenile Density","Diver Juvenile Density")
p2<-PlotMethod(site,"GENUS_CODE","JuvColDen","SSSS","Juvenile Density",1.5,60,"NS")
p3<-PlotHabitat(site,"GENUS_CODE","JuvColDen","SSSS","Juvenile Density",3,60,"Method x Habitat NS")
p4<-PlotDepth(site,"GENUS_CODE","JuvColDen","JuvColDen","SSSS","Juvenile Density",15,60,"Method x Depth NS")
JuvColDenS<-grid.arrange(p1,p2,p3,p4,nrow=2,ncol=2)
ggsave(plot<-JuvColDenS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/JuvColDenSSSS_stats.png",width=8,height=6)
#Ave Size- not perfect transformation, but will work
s<-subset(site,GENUS_CODE=="SSSS")
hist(log(s$Ave.size))
s$logAve.size<-log(s$Ave.size)
m<-lmer(logAve.size~METHOD + (1|SEC_NAME),data=s)
DPlots(m,s)
full.form <- formula(logAve.size ~ METHOD*MAX_DEPTH_M*HAB_R1, data=s)
#fit lme using "ML"= maximum likelihood - so can use step fxn
full.lme <-lme(full.form, data=s, random=~1|SEC_NAME, method="ML",na.action = na.omit) #use if needed
#drop 3-way interaction term & depth x habitat (not interested in these hypotheses)
FULL.MOD <- update(full.lme, .~. -METHOD:MAX_DEPTH_M:HAB_R1)
FULL.MOD <- update(FULL.MOD, .~. -MAX_DEPTH_M:HAB_R1)
anova(FULL.MOD) #from output, drop the 2-way interaction term with the larger p-value first
RED.MOD1 <- update(FULL.MOD, .~. -METHOD:HAB_R1) #drop 2-way interaction term
anova(FULL.MOD, RED.MOD1) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD2 <- update(RED.MOD1, .~. -METHOD:MAX_DEPTH_M) #drop 2-way interaction term
anova(RED.MOD1, RED.MOD2) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD3 <- update(RED.MOD2, .~. -METHOD) #drop 2-way interaction term
anova(RED.MOD2, RED.MOD3) #LRT --> move forward w/ whichever model keeps/removes term
#Extract predicted values for Adult density
#https://aosmith.rbind.io/2018/11/16/plot-fitted-lines/
library(nlme)
mod<-lme(logAve.size~METHOD*MAX_DEPTH_M, random = ~1|SEC_NAME,data=s,na.action=na.omit)
newdat.lme = data.frame(METHOD = s$METHOD,
MAX_DEPTH_M = rep(seq(0,30,by=0.29),2),
SEC_NAME = s$SEC_NAME)
head(newdat.lme)
newdat.lme$predlme <- predict(mod, newdata = newdat.lme, level=0)
newdat.lme$Ave.size<-exp(newdat.lme$predlme) #back transform predicted values
des = model.matrix(formula(mod)[-2], newdat.lme)
predvar = diag( des %*% vcov(mod) %*% t(des) )
newdat.lme$lower = with(newdat.lme, predlme - 2*sqrt(predvar) )
newdat.lme$upper = with(newdat.lme, predlme + 2*sqrt(predvar) )
newdat.lme$lower<-exp(newdat.lme$lower) #back transform predicted values
newdat.lme$upper<-exp(newdat.lme$upper) #back transform predicted values
p1<-Plot1to1_new(s.wide,"SfM_Ave.size","Diver_Ave.size","SfM Average Max Diameter (cm)","Diver Average Max Diameter (cm)")
p2<-PlotMethod(site,"GENUS_CODE","Ave.size","SSSS","Average Max Diameter (cm)",1.5,34,"NS")
p3<-PlotHabitat(site,"GENUS_CODE","Ave.size","SSSS","Average Max Diameter (cm)",3,34,"Method x Habitat NS")
p4<-PlotDepth(site,"GENUS_CODE","Ave.size","Ave.size","SSSS","Average Max Diameter (cm)",15,34,"Method x Depth NS")
Ave.sizeS<-grid.arrange(p1,p2,p3,p4,nrow=2,ncol=2)
ggsave(plot<-Ave.sizeS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/Ave.sizeSSSS_stats.png",width=8,height=6)
#Old dead- not perfect transformation, but will work
s<-subset(site,GENUS_CODE=="SSSS")
hist(sqrt(s$Ave.od))
s$sqAve.od<-sqrt(s$Ave.od)
mod<-lmer(sqAve.od~METHOD + (1|SEC_NAME),data=s)
DPlots(m,s)
full.form <- formula(sqAve.od ~ METHOD*MAX_DEPTH_M*HAB_R1, data=s)
#fit lme using "ML"= maximum likelihood - so can use step fxn
full.lme <-lme(full.form, data=s, random=~1|SEC_NAME, method="ML",na.action = na.omit) #use if needed
#drop 3-way interaction term & depth x habitat (not interested in these hypotheses)
FULL.MOD <- update(full.lme, .~. -METHOD:MAX_DEPTH_M:HAB_R1)
FULL.MOD <- update(FULL.MOD, .~. -MAX_DEPTH_M:HAB_R1)
anova(FULL.MOD) #from output, drop the 2-way interaction term with the larger p-value first
RED.MOD1 <- update(FULL.MOD, .~. -METHOD:MAX_DEPTH_M) #drop 2-way interaction term
anova(FULL.MOD, RED.MOD1) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD2 <- update(RED.MOD1, .~. -METHOD:HAB_R1) #drop 2-way interaction term
anova(RED.MOD1, RED.MOD2) #LRT --> move forward w/ whichever model keeps/removes term
RED.MOD3 <- update(RED.MOD2, .~. -METHOD) #drop 2-way interaction term
anova(RED.MOD2, RED.MOD3) #LRT --> move forward w/ whichever model keeps/removes term
#Extract predicted values for Adult density
#https://aosmith.rbind.io/2018/11/16/plot-fitted-lines/
library(nlme)
mod<-lme(sqAve.od~METHOD*MAX_DEPTH_M, random = ~1|SEC_NAME,data=s,na.action=na.omit)
newdat.lme = data.frame(METHOD = s$METHOD,
MAX_DEPTH_M = rep(seq(0,30,by=0.29),2),
SEC_NAME = s$SEC_NAME)
head(newdat.lme)
newdat.lme$predlme <- predict(mod, newdata = newdat.lme, level=0)
newdat.lme$Ave.od<-newdat.lme$predlme^2 #back transform predicted values
des = model.matrix(formula(mod)[-2], newdat.lme)
predvar = diag( des %*% vcov(mod) %*% t(des) )
newdat.lme$lower = with(newdat.lme, predlme - 2*sqrt(predvar) )
newdat.lme$upper = with(newdat.lme, predlme + 2*sqrt(predvar) )
newdat.lme$lower<-newdat.lme$lower^2 #back transform predicted values
newdat.lme$upper<-newdat.lme$upper^2 #back transform predicted values
p1<-Plot1to1_new(s.wide,"SfM_Ave.od","Diver_Ave.od","SfM Average % Old Dead","Diver % Old Dead")
p2<-PlotMethod(site,"GENUS_CODE","Ave.od","SSSS","Average % Old Dead",1.5,49,"Method Significant")
p2<-p2+geom_label(label="Method Significant", x=1.5,y=49,label.size = 0.35,color = "black", fill="#00BFC4")
p3<-PlotHabitat(site,"GENUS_CODE","Ave.od","SSSS","Average % Old Dead",3,49,"Method x Habitat NS")
p4<-PlotDepth(site,"GENUS_CODE","Ave.od","Ave.od","SSSS","Average % Old Dead",15,49,"Method x Depth NS")
Ave.odS<-grid.arrange(p1,p2,p3,p4,nrow=4,ncol=1)
ggsave(plot<-Ave.odS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/Ave.odSSSS_stats.png",width=8,height=6)
#Can't transform recent dead
hist(sqrt(s$Ave.rd))
s$logAve.rd<-log(s$Ave.rd+1)
mod<-lmer(logAve.rd~METHOD + (1|SEC_NAME),data=s)
plot(mod)
qqnorm(resid(mod)) #plot normal quantile- quantile plot.  Should be close to a straight line
#Remove sites that have 0s for both sfM and diver
s.wide<-subset(site.wide,GENUS_CODE=="SSSS")
s<-subset(site,GENUS_CODE=="SSSS");length(unique(s$SITE))
tmp <- s.wide[ which(s.wide$SfM_Ave.rd + s.wide$Diver_Ave.rd>0) , ]
sitelist<-unique(tmp$SITE)
s<-dplyr::filter(s, SITE %in% sitelist);length(unique(s$SITE))
s<-subset(site,GENUS_CODE=="SSSS");length(unique(s$SITE))
#Can't transform recent dead with sqrt, log or power transformation even after removing sites that have 0 rd in both sfm and diver
wilcox.test(Ave.rd ~ METHOD, data=s)
wilcox.test(Ave.rd ~ METHOD, data=subset(s,HAB_R1=="Aggregate Reef"))
wilcox.test(Ave.rd ~ METHOD, data=subset(s,HAB_R1=="Patch Reef"))
wilcox.test(Ave.rd ~ METHOD, data=subset(s,HAB_R1=="Pavement"))
wilcox.test(Ave.rd ~ METHOD, data=subset(s,HAB_R1=="Rock & Boulder"))
wilcox.test(Ave.rd ~ METHOD, data=subset(s,HAB_R1=="Rubble"))
t<-subset(s,METHOD=="Diver")
corr <- cor.test(x=t$MAX_DEPTH_M, y=t$Ave.rd, method = 'spearman')
corr
PlotDepth_NP<-function(d,grouping_field,metric_field,genus_field,metric_name){
d$GROUP<-d[,grouping_field]
d$METRIC<-d[,metric_field]
s<-subset(d,GROUP==genus_field)
p1<-ggplot(s, aes(x=MAX_DEPTH_M, y=METRIC,fill = METHOD,color=METHOD)) +
geom_smooth(method="lm")+
geom_point(size=1) +
theme_bw()+
theme(axis.text.x = element_text(angle = 0)
,plot.background = element_blank()
,panel.grid.major = element_blank()
,panel.grid.minor = element_blank()
,axis.ticks.x = element_blank() # no x axis ticks
,axis.title.x = element_text( vjust = -.0001) # adjust x axis to lower the same amount as the genus labels
,legend.position="none")+
labs(x="Max Depth (m)",y=metric_name)
return(p1)
}
p1<-Plot1to1_new(s.wide,"SfM_Ave.rd","Diver_Ave.rd","SfM Average % Recent Dead","Diver % Recent Dead")
p2<-PlotMethod(site,"GENUS_CODE","Ave.rd","SSSS","Average % Recent Dead",1.5,3.5,"NS")
p3<-PlotHabitat(site,"GENUS_CODE","Ave.rd","SSSS","Average % Recent Dead",3,34,"Method x Habitat NS")
p4<-PlotDepth_NP(site,"GENUS_CODE","Ave.rd","SSSS","Average % Recent Dead")
Ave.rdS<-grid.arrange(p1,p2,p3,p4,nrow=4,ncol=1)
ggsave(plot<-Ave.rdS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/Ave.rdSSSS_stats.png",width=8,height=6)
allplots<-grid.arrange(Ave.odS,Ave.rdS,nrow=1,ncol=3)
ggsave(plot<-allplots,file="T:/Benthic/Data/SfM/Method Comparision/Figures/PartialMortality_stats.png",width=8,height=10)
#Identify % of sites that had 0 rd for one method but not the other
a<-(s.wide[ which(s.wide$SfM_Ave.rd ==0 & s.wide$Diver_Ave.rd>0) , ])
nrow(a)/104
b<-(s.wide[ which(s.wide$SfM_Ave.rd >0 & s.wide$Diver_Ave.rd==0) , ])
nrow(b)/104
#Acute disease prevalence
s<-subset(site,GENUS_CODE=="SSSS")
s$AcuteDZ<-(s$AcuteDZ_prev/100)*s$AdColCount
s$test<-as.integer(as.character(s$AcuteDZ))
head(s)
s.wide<-subset(site.wide,GENUS_CODE=="SSSS")
s<-subset(site,GENUS_CODE=="SSSS");length(unique(s$SITE))
s$AcuteDZ<-(s$AcuteDZ_prev/100)*s$AdColCount
s$test<-as.integer(as.character(s$AcuteDZ))
head(s)
#try removing sites that had 0 for both methods- transformation doesn't work
tmp <- s.wide[ which(s.wide$SfM_AcuteDZ_prev + s.wide$Diver_AcuteDZ_prev>0) , ]
sitelist<-unique(tmp$SITE)
s<-dplyr::filter(s, SITE %in% sitelist);length(unique(s$SITE))
#try removing sites where you had 0 for either method - only 30 sites remain can't run analyses
tmp <- s.wide[ which(s.wide$SfM_AcuteDZ_prev>0 & s.wide$Diver_AcuteDZ_prev>0) , ]
#Can't transform recent dead with bionomial distrubtion, sqrt, log or power transformation even after removing sites that have 0 rd in both sfm and diver
s<-subset(site,GENUS_CODE=="SSSS")
wilcox.test(AcuteDZ_prev ~ METHOD, data=s)
wilcox.test(AcuteDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Aggregate Reef"))
wilcox.test(AcuteDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Patch Reef"))
wilcox.test(AcuteDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Pavement"))
wilcox.test(AcuteDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Rock & Boulder"))
wilcox.test(AcuteDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Rubble"))
pval<-c(0.155,
0.0681,
0.7014,
0.8823,
0.173)
p.adjust(pval,"BH")
t<-subset(s,METHOD=="Diver")
corr <- cor.test(x=t$MAX_DEPTH_M, y=t$AcuteDZ_prev, method = 'spearman')
corr
p1<-Plot1to1_new(s.wide,"SfM_AcuteDZ_prev","Diver_AcuteDZ_prev","SfM Prevalence (%)","Diver Prevalence (%)");p1<-p1+ggtitle("Acute Disease")
p2<-PlotMethod(site,"GENUS_CODE","AcuteDZ_prev","SSSS","Prevalence (%)",1.5,14,"NS")
p3<-PlotHabitat(site,"GENUS_CODE","AcuteDZ_prev","SSSS","Prevalence (%)",3,34,"Method x Habitat NS")
p4<-PlotDepth_NP(site,"GENUS_CODE","AcuteDZ_prev","SSSS","Prevalence (%)")
acutedzS<-grid.arrange(p1,p2,p3,p4,nrow=4,ncol=1)
#ggsave(plot<-acutedzS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/AcuteDZSSSS_stats.png",width=8,height=6)
#Identify % of sites that had 0 rd for one method but not the other
a<-(s.wide[ which(s.wide$SfM_AcuteDZ_prev ==0 & s.wide$Diver_AcuteDZ_prev>0) , ])
nrow(a)/104
b<-(s.wide[ which(s.wide$SfM_AcuteDZ_prev >0 & s.wide$Diver_AcuteDZ_prev==0) , ])
nrow(b)/104
#Chronic disease prevalence
s<-subset(site,GENUS_CODE=="SSSS")
s$ChronicDZ<-(s$ChronicDZ_prev/100)*s$AdColCount
s$test<-as.integer(as.character(s$ChronicDZ))
head(s)
s.wide<-subset(site.wide,GENUS_CODE=="SSSS")
s<-subset(site,GENUS_CODE=="SSSS");length(unique(s$SITE))
s$ChronicDZ<-(s$ChronicDZ_prev/100)*s$AdColCount
s$test<-as.integer(as.character(s$ChronicDZ))
head(s)
tmp <- s.wide[ which(s.wide$SfM_ChronicDZ_prev + s.wide$Diver_ChronicDZ_prev>0) , ]
sitelist<-unique(tmp$SITE)
s<-dplyr::filter(s, SITE %in% sitelist);length(unique(s$SITE))
#Can't transform recent dead with bionomial distrubtion, sqrt, log or power transformation even after removing sites that have 0 rd in both sfm and diver
s<-subset(site,GENUS_CODE=="SSSS")
wilcox.test(ChronicDZ_prev ~ METHOD, data=s)
wilcox.test(ChronicDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Aggregate Reef"))
wilcox.test(ChronicDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Patch Reef"))
wilcox.test(ChronicDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Pavement"))
wilcox.test(ChronicDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Rock & Boulder"))
wilcox.test(ChronicDZ_prev ~ METHOD, data=subset(s,HAB_R1=="Rubble"))
pval<-c(0.292,
0.462,
0.5963,
0.2551,
0.7221)
p.adjust(pval,"BH")
t<-subset(s,METHOD=="SfM")
corr <- cor.test(x=t$MAX_DEPTH_M, y=t$ChronicDZ_prev, method = 'spearman')
corr
p1<-Plot1to1_new(s.wide,"SfM_ChronicDZ_prev","Diver_ChronicDZ_prev","SfM Prevalence (%)","Diver Prevalence (%)");p1<-p1+ggtitle("Chronic Disease")
p2<-PlotMethod(site,"GENUS_CODE","ChronicDZ_prev","SSSS","Prevalence (%)",1.5,9.5,"NS")
p3<-PlotHabitat(site,"GENUS_CODE","ChronicDZ_prev","SSSS","Prevalence (%)",3,34,"Method x Habitat NS")
p4<-PlotDepth_NP(site,"GENUS_CODE","ChronicDZ_prev","SSSS","Prevalence (%)")
ChronicdzS<-grid.arrange(p1,p2,p3,p4,nrow=4,ncol=1)
#ggsave(plot<-ChronicdzS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/ChronicDZSSSS_stats.png",width=8,height=6)
#Identify % of sites that had 0 rd for one method but not the other
a<-(s.wide[ which(s.wide$SfM_ChronicDZ_prev ==0 & s.wide$Diver_ChronicDZ_prev>0) , ])
nrow(a)/104
b<-(s.wide[ which(s.wide$SfM_ChronicDZ_prev >0 & s.wide$Diver_ChronicDZ_prev==0) , ])
nrow(b)/104
#Bleaching prevalence
s<-subset(site,GENUS_CODE=="SSSS")
s$BLE<-(s$BLE_prev/100)*s$AdColCount
s$test<-as.integer(as.character(s$BLE))
head(s)
s.wide<-subset(site.wide,GENUS_CODE=="SSSS")
s<-subset(site,GENUS_CODE=="SSSS");length(unique(s$SITE))
s$BLE<-(s$BLE_prev/100)*s$AdColCount
s$test<-as.integer(as.character(s$BLE))
head(s)
tmp <- s.wide[ which(s.wide$SfM_BLE_prev + s.wide$Diver_BLE_prev>0) , ]
sitelist<-unique(tmp$SITE)
s<-dplyr::filter(s, SITE %in% sitelist);length(unique(s$SITE))
s<-subset(site,GENUS_CODE=="SSSS")
wilcox.test(BLE_prev ~ METHOD, data=s)
wilcox.test(BLE_prev ~ METHOD, data=subset(s,HAB_R1=="Aggregate Reef"))
wilcox.test(BLE_prev ~ METHOD, data=subset(s,HAB_R1=="Patch Reef"))
wilcox.test(BLE_prev ~ METHOD, data=subset(s,HAB_R1=="Pavement"))
wilcox.test(BLE_prev ~ METHOD, data=subset(s,HAB_R1=="Rock & Boulder"))
wilcox.test(BLE_prev ~ METHOD, data=subset(s,HAB_R1=="Rubble"))
pval<-c(0.002771,
0.6781,
0.1804,
0.06162,
0.413)
p.adjust(pval,"BH")
#Old dead- not perfect transformation, but will work
s<-subset(site,GENUS_CODE=="SSSS")
hist(sqrt(s$Ave.od))
s$sqAve.od<-sqrt(s$Ave.od)
mod<-lmer(sqAve.od~METHOD + (1|SEC_NAME),data=s)
DPlots(m,s)
p1<-Plot1to1_new(s.wide,"SfM_Ave.od","Diver_Ave.od","SfM Average % Old Dead","Diver % Old Dead")
p2<-PlotMethod(site,"GENUS_CODE","Ave.od","SSSS","Average % Old Dead",1.5,49,"Method Significant")
p2<-p2+geom_label(label="Method Significant", x=1.5,y=49,label.size = 0.35,color = "black", fill="#00BFC4")
p3<-PlotHabitat(site,"GENUS_CODE","Ave.od","SSSS","Average % Old Dead",3,49,"Method x Habitat NS")
p4<-PlotDepth(site,"GENUS_CODE","Ave.od","Ave.od","SSSS","Average % Old Dead",15,49,"Method x Depth NS")
Ave.odS<-grid.arrange(p1,p2,p3,p4,nrow=4,ncol=1)
ggsave(plot<-Ave.odS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/Ave.odSSSS_stats.png",width=8,height=6)
Ave.odS<-grid.arrange(p1,p2,p3,p4,nrow=2,ncol=2)
ggsave(plot<-Ave.odS,file="T:/Benthic/Data/SfM/Method Comparision/Figures/Ave.odSSSS_stats.png",width=8,height=6)
View(PlotMethod)
View(PlotMethod)
1124+240+5000
7036+435+48169
10492+1124+7036+240+435+20000+20000+5000
64327+5000+48169
117496+2828
11300-8000-1700
4760+644+235+445+200
120324/6284
1.5+7
200*8.5
(2660-2133)/2133
(2860-2133)/2133
117/40
117/8
